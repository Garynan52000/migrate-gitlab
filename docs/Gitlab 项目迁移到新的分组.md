# Gitlab 项目迁移到新的分组

## `move.md` 格式参考

### `## 需要迁移仓库`

- 格式是表格，列有项目名称、项目描述、原仓库地址。

### `## 迁移目标分组`

- 是一个 gitlab 分组的网址，如 `https://target-gitlab.com/some-group`。

### `## 日志`

- 日志记录以下信息：
    - 项目名称
    - 项目描述
    - 原仓库地址
    - 目标分组
    - 目标仓库地址
    - 开始时间
    - 结束时间
    - 耗时
    - 是否已克隆原仓库镜像
    - 是否已创建目标仓库
    - 是否已推送镜像到目标仓库
    - 是否已修改目标仓库的项目描述
    - 是否已克隆迁移后的仓库
    - 警告原因（如果有）
    - 失败原因（如果有）

## 使用 Git 命令行迁移

### 1. 克隆原仓库（包含所有分支和标签）

```bash
git clone --mirror https://source-gitlab.com/username/repository.git
```

`--mirror` 参数会克隆所有分支、标签和引用，保持完整的仓库结构。

### 2. 进入克隆的仓库目录

```bash
cd repository.git
```

### 3. 添加新的远程仓库地址

```bash
git remote set-url origin https://target-gitlab.com/username/repository.git
```

### 4. 推送所有内容到新仓库

```bash
git push --mirror
```

## 迁移步骤

1. 准备工作
    - 检查 `move.md` 文件格式是否正确
    - 阅读 `move.md` 文件，确认需要迁移的项目和目标分组

2. 对每个需要迁移的仓库执行以下操作：

    a. 检查目标分组中是否已存在同名仓库
        - 如果已存在，直接在日志中记录迁移失败，并跳过当前仓库的迁移
        - 如果不存在，继续下一个仓库的迁移

    b. 检查日志中是否已记录该项目的迁移
        - 跳过过已完成的迁移步骤
        - 继续未完成的迁移步骤
        - 所有迁移步骤已完成，则记录迁移成功，继续下一个仓库的迁移

    c. 记录开始时间
    
    d. 克隆原仓库镜像
    ```bash
    git clone --mirror <原仓库地址>
    ```
    
    e. 在目标分组创建新仓库
        - 使用 `move.md` 中记录的项目名称
        - 使用 `move.md` 中记录的项目描述

    f. 推送镜像到新仓库
    ```bash
    cd <仓库目录>.git
    git remote set-url origin <新仓库地址>
    git push --mirror
    ```
    
    g. 设置新仓库的项目描述
    
    h. 记录结束时间和耗时
    
    i. 克隆迁移后的仓库到 `move.md` 所在的目录中

    j. 更新日志。按文档中的格式要求更新到 `move.md` 中

3. 清理工作
    - 删除所有临时克隆的仓库目录
    - 检查日志完整性
    - 生成迁移报告，包含成功和失败的统计

4. 验证工作
    - 检查所有迁移的仓库是否可访问
    - 验证分支和标签是否完整迁移
    - 确认项目描述是否正确设置
    - 检查仓库权限设置是否合适

5. 异常处理
    - 如果单个仓库迁移失败：
        - 记录详细错误信息
        - 根据情况决定是继续其他仓库迁移还是终止整个过程
    - 如果遇到网络问题：
        - 适当延迟后重试
        - 记录重试次数和结果

## 重点注意

- 按照本文档中 `## 迁移步骤` 这部分的要求，迁移每个项目。每个步骤都不可省略。
- 使用 git 命令操作时，无需使用 Access Token，直接使用用户名和密码即可。
- 所有提示和输出，尽量使用中文
- 注意中文编码问题，特别注意如：
    - 更改项目名称
    - 更改项目描述等
    - 等等
- 如果需要创建文件，如脚本等，请在 `move.md` 的同级目录下创建
- 遇到需要删除文件的情况，如非必要情况，均放所以操作结束之后再执行
- 所以操作完成后，删除临时文件如：
    - 原仓库的克隆目录
    - 迁移过程中创建的脚本
    - 等等
