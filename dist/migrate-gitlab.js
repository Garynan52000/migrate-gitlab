#!/usr/bin/env bun
// @bun
import{execSync as N}from"child_process";import{readFileSync as P,writeFileSync as b,existsSync as J,rmSync as U,mkdirSync as k,readdirSync as R,statSync as T}from"fs";import*as W from"path";import*as h from"readline";class K{static RESET="\x1B[0m";static BRIGHT="\x1B[1m";static DIM="\x1B[2m";static RED="\x1B[31m";static GREEN="\x1B[32m";static YELLOW="\x1B[33m";static BLUE="\x1B[34m";static MAGENTA="\x1B[35m";static CYAN="\x1B[36m";static WHITE="\x1B[37m";static GRAY="\x1B[90m";static BG_RED="\x1B[41m";static BG_GREEN="\x1B[42m";static BG_YELLOW="\x1B[43m";static BG_BLUE="\x1B[44m";static success(Q){return`${K.GREEN}${K.BRIGHT}\u2705 ${Q}${K.RESET}`}static error(Q){return`${K.RED}${K.BRIGHT}\u274C ${Q}${K.RESET}`}static warning(Q){return`${K.YELLOW}${K.BRIGHT}\u26A0\uFE0F  ${Q}${K.RESET}`}static info(Q){return`${K.BLUE}${K.BRIGHT}\u2139\uFE0F  ${Q}${K.RESET}`}static progress(Q){return`${K.CYAN}${K.BRIGHT}\uD83D\uDE80 ${Q}${K.RESET}`}static highlight(Q){return`${K.MAGENTA}${K.BRIGHT}${Q}${K.RESET}`}static dim(Q){return`${K.GRAY}${Q}${K.RESET}`}static title(Q){return`${K.CYAN}${K.BRIGHT}\uD83C\uDFAF ${Q}${K.RESET}`}static separator(Q=50){return`${K.GRAY}${"\u2550".repeat(Q)}${K.RESET}`}static box(Q){let B=Q.split(`
`),X=Math.max(...B.map((A)=>A.length)),Y="\u2550".repeat(X+4),$=`${K.CYAN}\u2554${Y}\u2557${K.RESET}
`;return B.forEach((A)=>{let Z=" ".repeat(X-A.length);$+=`${K.CYAN}\u2551  ${K.WHITE}${A}${Z}  ${K.CYAN}\u2551${K.RESET}
`}),$+=`${K.CYAN}\u255A${Y}\u255D${K.RESET}`,$}static step(Q,B){return`${K.BLUE}${K.BRIGHT}\uD83D\uDCCB \u6B65\u9AA4 ${Q}:${K.RESET} ${K.WHITE}${B}${K.RESET}`}static duration(Q){return`${K.GRAY}\u23F1\uFE0F  ${Q}${K.RESET}`}static url(Q){return`${K.BLUE}\uD83D\uDD17 ${Q}${K.RESET}`}static repo(Q){return`${K.MAGENTA}${K.BRIGHT}\uD83D\uDCE6 ${Q}${K.RESET}`}static description(Q){return`${K.GRAY}\uD83D\uDCDD ${Q}${K.RESET}`}}function y(){return new Promise((Q)=>{let B=h.createInterface({input:process.stdin,output:void 0,terminal:!1}),X=process.stdin;X.setRawMode(!0),X.resume(),X.setEncoding("utf8");let Y="";console.log(`
\uD83D\uDD11 \u8BF7\u8F93\u5165 GitLab Access Token (\u9690\u853D\u8F93\u5165\uFF0C\u70B9\u51FB\u53F3\u952E\u4E00\u4E0B\u5373\u53EF\u7C98\u8D34):`),X.on("data",($)=>{if($==="\r"||$===`
`){X.setRawMode(!1),X.pause(),B.close(),console.log(`
\u2705 Access Token \u5DF2\u8F93\u5165`),Q(Y.trim());return}if($==="\b"||$==="\x7F"){if(Y.length>0)Y=Y.slice(0,-1);return}if($==="\x03")console.log(`
\u274C \u7528\u6237\u53D6\u6D88\u8F93\u5165`),process.exit(1);if($.charCodeAt(0)>=32)Y+=$})})}class f{moveFilePath;accessToken;targetGroupUrl;repositories;logs;selectedProjects;tempDir;saveTimeout=null;skipFinalClone;quietMode;constructor(Q=W.resolve(process.cwd(),"move.md"),B,X,Y=!1,$=!1){this.moveFilePath=Q,this.accessToken=X||"",this.skipFinalClone=Y,this.quietMode=$,this.targetGroupUrl="",this.repositories=[],this.logs=new Map,this.selectedProjects=B||[];let A=new Date().toISOString().replace(/[:.]/g,"-"),Z=Math.random().toString(36).substring(2,8);this.tempDir=W.join(process.cwd(),`temp-migration-${A}-${Z}`),this.cleanupOldBackups(),this.cleanupOldTempDirectories()}parseMoveFile(){if(console.log("\uD83D\uDCD6 \u6B63\u5728\u89E3\u6790move.md\u6587\u4EF6..."),!J(this.moveFilePath))throw new Error(`move.md\u6587\u4EF6\u4E0D\u5B58\u5728: ${this.moveFilePath}`);let Q=P(this.moveFilePath,"utf-8"),B=Q.split(`
`),X=[];if(!this.accessToken){let Z=B.findIndex((V)=>V.includes("## \u8FC1\u79FB\u76EE\u6807 Access Token"));if(Z!==-1&&Z+2<B.length){let V=B[Z+2].trim();if(V&&V!=="your_gitlab_access_token"&&V!=="your_access_token")this.accessToken=V,console.log("\uD83D\uDD11 \u4ECE move.md \u6587\u4EF6\u4E2D\u8BFB\u53D6\u5230 Access Token")}else X.push("\u672A\u627E\u5230\u6709\u6548\u7684 Access Token \u914D\u7F6E")}let Y=B.findIndex((Z)=>Z.includes("## \u8FC1\u79FB\u76EE\u6807\u5206\u7EC4"));if(Y!==-1&&Y+2<B.length){if(this.targetGroupUrl=B[Y+2].trim(),!this.targetGroupUrl)X.push("\u76EE\u6807\u5206\u7EC4URL\u4E3A\u7A7A");else if(!this.isValidUrl(this.targetGroupUrl))X.push(`\u76EE\u6807\u5206\u7EC4URL\u683C\u5F0F\u65E0\u6548: ${this.targetGroupUrl}`)}else X.push("\u672A\u627E\u5230\u76EE\u6807\u5206\u7EC4\u914D\u7F6E");let $=B.findIndex((Z)=>Z.includes("| \u9879\u76EE\u540D\u79F0 | \u9879\u76EE\u63CF\u8FF0 | \u539F\u4ED3\u5E93\u5730\u5740 |"));if($!==-1){let Z=0;for(let V=$+2;V<B.length;V++){let _=B[V].trim(),G=V+1;if(!_||_.includes("## \u65E5\u5FD7")||_.includes("## "))break;if(_.match(/^\|[-\s|]+\|$/))continue;if(!_.startsWith("|")||!_.endsWith("|")){X.push(`\u7B2C${G}\u884C\u683C\u5F0F\u9519\u8BEF\uFF1A\u8868\u683C\u884C\u5FC5\u987B\u4EE5 | \u5F00\u5934\u548C\u7ED3\u5C3E`);continue}let q=_.split("|").map((z)=>z.trim()).filter((z)=>z);if(q.length<3){X.push(`\u7B2C${G}\u884C\u6570\u636E\u4E0D\u5B8C\u6574\uFF1A\u9700\u8981\u81F3\u5C113\u5217\u6570\u636E\uFF08\u9879\u76EE\u540D\u79F0\u3001\u9879\u76EE\u63CF\u8FF0\u3001\u539F\u4ED3\u5E93\u5730\u5740\uFF09`);continue}let[H,I,O]=q;if(!H){X.push(`\u7B2C${G}\u884C\uFF1A\u9879\u76EE\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A`);continue}if(!O){X.push(`\u7B2C${G}\u884C\uFF1A\u539F\u4ED3\u5E93\u5730\u5740\u4E0D\u80FD\u4E3A\u7A7A`);continue}if(!this.isValidGitUrl(O)){X.push(`\u7B2C${G}\u884C\uFF1A\u539F\u4ED3\u5E93\u5730\u5740\u683C\u5F0F\u65E0\u6548: ${O}`);continue}if(this.repositories.some((z)=>z.name===H)){X.push(`\u7B2C${G}\u884C\uFF1A\u9879\u76EE\u540D\u79F0\u91CD\u590D: ${H}`);continue}this.repositories.push({name:H,description:I||"\u65E0\u63CF\u8FF0",originalUrl:O}),Z++}if(Z===0)X.push("\u672A\u627E\u5230\u6709\u6548\u7684\u4ED3\u5E93\u914D\u7F6E")}else X.push("\u672A\u627E\u5230\u4ED3\u5E93\u5217\u8868\u8868\u683C");if(this.parseExistingLogs(Q),X.length>0)console.log(K.warning("\u26A0\uFE0F  \u914D\u7F6E\u6587\u4EF6\u89E3\u6790\u8B66\u544A:")),X.forEach((Z)=>{console.log(K.dim(`   \u2022 ${Z}`))}),console.log("");console.log(`\u2705 \u89E3\u6790\u5B8C\u6210\uFF0C\u627E\u5230 ${this.repositories.length} \u4E2A\u5F85\u8FC1\u79FB\u4ED3\u5E93`),console.log(`\uD83C\uDFAF \u76EE\u6807\u5206\u7EC4: ${this.targetGroupUrl}`);let A=this.validateConfiguration();if(A.warnings.length>0)console.log(K.warning("\u26A0\uFE0F  \u914D\u7F6E\u9A8C\u8BC1\u8B66\u544A:")),A.warnings.forEach((Z)=>{console.log(K.dim(`   \u2022 ${Z}`))}),console.log("");if(A.errors.length>0)throw console.log(K.error("\u274C \u914D\u7F6E\u9A8C\u8BC1\u9519\u8BEF:")),A.errors.forEach((Z)=>{console.log(K.dim(`   \u2022 ${Z}`))}),console.log(""),new Error("\u914D\u7F6E\u6587\u4EF6\u9A8C\u8BC1\u5931\u8D25\uFF0C\u8BF7\u4FEE\u590D\u4E0A\u8FF0\u9519\u8BEF\u540E\u91CD\u8BD5");if(!this.targetGroupUrl||this.repositories.length===0)throw new Error("\u914D\u7F6E\u6587\u4EF6\u89E3\u6790\u5931\u8D25\uFF1A\u7F3A\u5C11\u5FC5\u8981\u7684\u914D\u7F6E\u4FE1\u606F")}isValidUrl(Q){try{return new URL(Q),!0}catch{return!1}}isValidGitUrl(Q){return/^(https?:\/\/|ssh:\/\/git@|git@)[\w\.-]+(:\d+)?[:\/][\w\.-]+\/[\w\.-]+(\.git)?\/?$/.test(Q)}validateConfiguration(){let Q=[],B=[];if(!this.accessToken||this.accessToken==="your_gitlab_access_token"||this.accessToken==="your_access_token")B.push("Access Token \u672A\u914D\u7F6E\u6216\u4F7F\u7528\u9ED8\u8BA4\u503C\uFF0C\u9700\u8981\u901A\u8FC7\u5176\u4ED6\u65B9\u5F0F\u63D0\u4F9B");else if(this.accessToken.length<20)B.push("Access Token \u957F\u5EA6\u53EF\u80FD\u4E0D\u6B63\u786E\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u4E3A\u6709\u6548\u7684 GitLab Access Token");if(!this.targetGroupUrl)Q.push("\u76EE\u6807\u5206\u7EC4URL\u672A\u914D\u7F6E");else if(!this.isValidUrl(this.targetGroupUrl))Q.push(`\u76EE\u6807\u5206\u7EC4URL\u683C\u5F0F\u65E0\u6548: ${this.targetGroupUrl}`);else if(!this.targetGroupUrl.includes("gitlab"))B.push("\u76EE\u6807\u5206\u7EC4URL\u4F3C\u4E4E\u4E0D\u662FGitLab\u5730\u5740\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u6B63\u786E");if(this.repositories.length===0)Q.push("\u672A\u627E\u5230\u4EFB\u4F55\u5F85\u8FC1\u79FB\u7684\u4ED3\u5E93");else{let X=new Set,Y=[];if(this.repositories.forEach(($)=>{if(X.has($.name))Y.push($.name);else X.add($.name);if(!/^[a-zA-Z0-9_-]+$/.test($.name))B.push(`\u4ED3\u5E93\u540D\u79F0 "${$.name}" \u5305\u542B\u7279\u6B8A\u5B57\u7B26\uFF0C\u53EF\u80FD\u5BFC\u81F4\u521B\u5EFA\u5931\u8D25`);if(!this.isValidGitUrl($.originalUrl))Q.push(`\u4ED3\u5E93 "${$.name}" \u7684\u539F\u4ED3\u5E93\u5730\u5740\u683C\u5F0F\u65E0\u6548: ${$.originalUrl}`);if($.description&&$.description.length>2000)B.push(`\u4ED3\u5E93 "${$.name}" \u7684\u63CF\u8FF0\u8FC7\u957F\uFF0C\u53EF\u80FD\u88AB\u622A\u65AD`)}),Y.length>0)Q.push(`\u53D1\u73B0\u91CD\u590D\u7684\u4ED3\u5E93\u540D\u79F0: ${Y.join(", ")}`)}if(this.selectedProjects.length>0){let X=this.selectedProjects.filter((Y)=>!this.repositories.some(($)=>$.name===Y));if(X.length>0)Q.push(`\u6307\u5B9A\u7684\u9879\u76EE\u4E0D\u5B58\u5728: ${X.join(", ")}`)}return{isValid:Q.length===0,errors:Q,warnings:B}}parseExistingLogs(Q){let B=Q.split(`
`),X=null;for(let Y=0;Y<B.length;Y++){let $=B[Y].trim();if($.startsWith("### ")&&!$.includes("paimai-activity")){if(X&&X.projectName)this.logs.set(X.projectName,X);X={projectName:$.substring(4).trim(),projectDescription:"",originalRepoUrl:"",targetGroup:"",targetRepoUrl:"",startTime:"",endTime:"",duration:"",isOriginalCloned:!1,isTargetCreated:!1,isMirrorPushed:!1,isDescriptionUpdated:!1,isFinalCloned:!1,failureReason:"",steps:[],warnings:[],retryCount:0,lastUpdated:new Date().toISOString()}}if(X&&$.startsWith("- **")){let A=$.match(/- \*\*(.+?)\*\*: (.*)/);if(A){let[,Z,V]=A;switch(Z){case"\u9879\u76EE\u63CF\u8FF0":X.projectDescription=V;break;case"\u539F\u4ED3\u5E93\u5730\u5740":X.originalRepoUrl=V;break;case"\u76EE\u6807\u5206\u7EC4":X.targetGroup=V;break;case"\u76EE\u6807\u4ED3\u5E93\u5730\u5740":X.targetRepoUrl=V;break;case"\u5F00\u59CB\u65F6\u95F4":X.startTime=V;break;case"\u7ED3\u675F\u65F6\u95F4":X.endTime=V;break;case"\u8017\u65F6":X.duration=V;break;case"\u662F\u5426\u5DF2\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF":X.isOriginalCloned=V==="\u2705";break;case"\u662F\u5426\u5DF2\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93":X.isTargetCreated=V==="\u2705";break;case"\u662F\u5426\u5DF2\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93":X.isMirrorPushed=V==="\u2705";break;case"\u662F\u5426\u5DF2\u4FEE\u6539\u76EE\u6807\u4ED3\u5E93\u7684\u9879\u76EE\u63CF\u8FF0":X.isDescriptionUpdated=V==="\u2705";break;case"\u662F\u5426\u5DF2\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93":X.isFinalCloned=V==="\u2705";break;case"\u5931\u8D25\u539F\u56E0":X.failureReason=V;break}}}}if(X&&X.projectName)this.logs.set(X.projectName,X);console.log(`\uD83D\uDCCB \u89E3\u6790\u5230 ${this.logs.size} \u4E2A\u73B0\u6709\u65E5\u5FD7\u8BB0\u5F55`),this.cleanupOrphanedLogs()}cleanupOrphanedLogs(){let Q=new Set(this.repositories.map((X)=>X.name)),B=[];for(let[X]of this.logs)if(!Q.has(X))B.push(X);if(B.length>0)console.log(`\uD83E\uDDF9 \u6E05\u7406 ${B.length} \u4E2A\u4E0D\u5728\u914D\u7F6E\u6587\u4EF6\u4E2D\u7684\u9879\u76EE\u65E5\u5FD7: ${B.join(", ")}`),B.forEach((X)=>{this.logs.delete(X)})}getGitLabApiBase(){let Q=new URL(this.targetGroupUrl);return`${Q.protocol}//${Q.host}/api/v4`}extractGroupPath(Q){try{let X=new URL(Q).pathname;if(X.startsWith("/"))X=X.substring(1);if(X.endsWith("/"))X=X.slice(0,-1);return X}catch(B){throw new Error(`\u65E0\u6548\u7684\u5206\u7EC4URL: ${Q}`)}}async getGroupId(Q){try{let B=this.extractGroupPath(Q),X=`${this.getGitLabApiBase()}/groups/${encodeURIComponent(B)}`,Y=await fetch(X,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(!Y.ok)throw new Error(`\u83B7\u53D6\u5206\u7EC4\u4FE1\u606F\u5931\u8D25\uFF0CHTTP\u72B6\u6001\u7801: ${Y.status}`);return(await Y.json()).id}catch(B){throw new Error(`\u83B7\u53D6\u5206\u7EC4ID\u5931\u8D25: ${B.message}`)}}executeCommand(Q,B){try{if(!this.quietMode)console.log(K.dim(`\u6267\u884C\u547D\u4EE4: ${Q}`));let X=N(Q,{cwd:B||process.cwd(),encoding:"utf-8",stdio:"pipe"});if(!this.quietMode)console.log(K.dim("\u547D\u4EE4\u6267\u884C\u6210\u529F"));return X.toString().trim()}catch(X){throw console.log(K.error(`\u547D\u4EE4\u6267\u884C\u5931\u8D25: ${Q}`)),new Error(`\u547D\u4EE4\u6267\u884C\u5931\u8D25: ${Q}
\u9519\u8BEF\u4FE1\u606F: ${X.message}`)}}executeCommandWithProgress(Q,B){try{if(!this.quietMode)console.log(K.dim(`\u6267\u884C\u547D\u4EE4: ${Q}`));let X=N(Q,{cwd:B||process.cwd(),encoding:"utf-8",stdio:this.quietMode?"pipe":"inherit"});if(!this.quietMode)console.log(K.dim("\u547D\u4EE4\u6267\u884C\u6210\u529F"));return X?X.toString().trim():""}catch(X){throw console.log(K.error(`\u547D\u4EE4\u6267\u884C\u5931\u8D25: ${Q}`)),new Error(`\u547D\u4EE4\u6267\u884C\u5931\u8D25: ${Q}
\u9519\u8BEF\u4FE1\u606F: ${X.message}`)}}executeCommandWithWarningSupport(Q,B){try{console.log(K.dim(`\u6267\u884C\u547D\u4EE4: ${Q}`));let X=N(Q,{cwd:B||process.cwd(),encoding:"utf-8",stdio:"pipe"});return console.log(K.dim("\u547D\u4EE4\u6267\u884C\u6210\u529F")),{success:!0,output:X.toString().trim()}}catch(X){let Y=X.message||"";if(Y.includes("deny updating a hidden ref")||Y.includes("refs/keep-around")||Y.includes("refs/merge-requests")||Y.includes("refs/pipelines")||Y.includes("refs/environments")||Y.includes("refs/heads/")||Y.includes("refs/tags/")||Y.includes("hidden ref")||Y.includes("refusing to update checked out branch")||Y.includes("remote rejected")||Y.includes("pre-receive hook declined")||Y.includes("! [remote rejected]")||Y.includes("hook declined")||Y.includes("protected branch")||Y.includes("To ")||Y.includes("Everything up-to-date")||Y.includes("non-fast-forward")||Y.includes("failed to push some refs")||Y.includes("updates were rejected")||Y.includes("fetch first")||Y.includes("hint: Updates were rejected")||Y.includes("error: failed to push"))return console.log(K.warning(`\u26A0\uFE0F  \u8B66\u544A: ${Y}`)),console.log(K.info("\u8FD9\u662F\u4E00\u4E2A\u9690\u85CF\u5F15\u7528\u76F8\u5173\u7684\u8B66\u544A\uFF0C\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C")),{success:!0,output:"",warning:Y};if(Y.includes("EBUSY: resource busy or locked")||Y.includes("resource busy or locked")||Y.includes("cannot delete")||Y.includes("cannot remove")||Y.includes("ENOENT: no such file or directory")||Y.includes("no such file or directory")||Y.includes("ENOSPC: no space left on device")||Y.includes("no space left on device")){if(!this.quietMode)console.log(K.warning("\u26A0\uFE0F  \u8B66\u544A: \u6587\u4EF6\u7CFB\u7EDF\u64CD\u4F5C\u9047\u5230\u95EE\u9898")),console.log(K.info("\u8FD9\u662F\u4E00\u4E2A\u6587\u4EF6\u7CFB\u7EDF\u76F8\u5173\u7684\u8B66\u544A\uFF0C\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C"));return{success:!0,output:"",warning:"\u6587\u4EF6\u7CFB\u7EDF\u64CD\u4F5C\u9047\u5230\u95EE\u9898\uFF0C\u4F46\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C"}}throw console.log(K.error(`\u547D\u4EE4\u6267\u884C\u5931\u8D25: ${Q}`)),new Error(`\u547D\u4EE4\u6267\u884C\u5931\u8D25: ${Q}
\u9519\u8BEF\u4FE1\u606F: ${Y}`)}}executeCommandWithWarningAndProgress(Q,B){try{if(!this.quietMode)console.log(K.dim(`\u6267\u884C\u547D\u4EE4: ${Q}`));let X=N(Q,{cwd:B||process.cwd(),encoding:"utf-8",stdio:this.quietMode?"pipe":"inherit"});if(!this.quietMode)console.log(K.dim("\u547D\u4EE4\u6267\u884C\u6210\u529F"));return{success:!0,output:X?X.toString().trim():""}}catch(X){let Y=X.message||"",$=X.stderr?X.stderr.toString():"",A=X.stdout?X.stdout.toString():"",Z=`${Y}
${$}
${A}`.trim();if(Z.includes("deny updating a hidden ref")||Z.includes("refs/keep-around")||Z.includes("refs/merge-requests")||Z.includes("refs/pipelines")||Z.includes("refs/environments")||Z.includes("refs/heads/")||Z.includes("refs/tags/")||Z.includes("hidden ref")||Z.includes("refusing to update checked out branch")||Z.includes("remote rejected")||Z.includes("pre-receive hook declined")||Z.includes("! [remote rejected]")||Z.includes("hook declined")||Z.includes("protected branch")||Z.includes("To ")||Z.includes("Everything up-to-date")||Z.includes("non-fast-forward")||Z.includes("failed to push some refs")||Z.includes("updates were rejected")||Z.includes("fetch first")||Z.includes("hint: Updates were rejected")||Z.includes("error: failed to push")||$.includes("deny updating a hidden ref")||$.includes("refs/keep-around")||$.includes("refs/merge-requests")||$.includes("refs/pipelines")||$.includes("refs/environments")||$.includes("refs/heads/")||$.includes("refs/tags/")||$.includes("remote rejected")||$.includes("! [remote rejected]")||$.includes("hook declined")||$.includes("protected branch")||$.includes("To ")||$.includes("Everything up-to-date")||$.includes("non-fast-forward")||$.includes("failed to push some refs")||$.includes("updates were rejected")||$.includes("fetch first")||$.includes("hint: Updates were rejected")||$.includes("error: failed to push")){if(!this.quietMode)console.log(K.warning("\u26A0\uFE0F  \u8B66\u544A: \u63A8\u9001\u8FC7\u7A0B\u4E2D\u9047\u5230\u9690\u85CF\u5F15\u7528\u76F8\u5173\u8B66\u544A")),console.log(K.info("\u8FD9\u662F\u4E00\u4E2A\u9690\u85CF\u5F15\u7528\u76F8\u5173\u7684\u8B66\u544A\uFF0C\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C"));return{success:!0,output:A,warning:"\u63A8\u9001\u8FC7\u7A0B\u4E2D\u9047\u5230\u9690\u85CF\u5F15\u7528\u76F8\u5173\u8B66\u544A\uFF0C\u4F46\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C"}}if(Z.includes("EBUSY: resource busy or locked")||Z.includes("resource busy or locked")||Z.includes("cannot delete")||Z.includes("cannot remove")||Z.includes("ENOENT: no such file or directory")||Z.includes("no such file or directory")||Z.includes("ENOSPC: no space left on device")||Z.includes("no space left on device")||$.includes("EBUSY: resource busy or locked")||$.includes("resource busy or locked")||$.includes("cannot delete")||$.includes("cannot remove")){if(!this.quietMode)console.log(K.warning("\u26A0\uFE0F  \u8B66\u544A: \u6587\u4EF6\u7CFB\u7EDF\u64CD\u4F5C\u9047\u5230\u95EE\u9898")),console.log(K.info("\u8FD9\u662F\u4E00\u4E2A\u6587\u4EF6\u7CFB\u7EDF\u76F8\u5173\u7684\u8B66\u544A\uFF0C\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C"));return{success:!0,output:A,warning:"\u6587\u4EF6\u7CFB\u7EDF\u64CD\u4F5C\u9047\u5230\u95EE\u9898\uFF0C\u4F46\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C"}}if(!this.quietMode)console.log(K.error(`\u547D\u4EE4\u6267\u884C\u5931\u8D25: ${Q}`));throw new Error(`\u547D\u4EE4\u6267\u884C\u5931\u8D25: ${Q}
\u9519\u8BEF\u4FE1\u606F: ${Z}`)}}async checkRepositoryExists(Q){try{console.log(`\uD83D\uDD0D \u68C0\u67E5\u4ED3\u5E93\u662F\u5426\u5B58\u5728: ${Q}`);let B=this.extractGroupPath(this.targetGroupUrl),X=`${this.getGitLabApiBase()}/projects/${encodeURIComponent(B+"/"+Q)}`,Y=await fetch(X,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(Y.status===200){let $=await Y.json();if(console.log(`\u26A0\uFE0F \u4ED3\u5E93\u5DF2\u5B58\u5728: ${Q}`),await this.checkIfRepositoryIsEmpty($.id)){if(console.log(K.warning(`\u26A0\uFE0F \u76EE\u6807\u4ED3\u5E93 ${K.highlight(Q)} \u662F\u4E00\u4E2A\u7A7A\u4ED3\u5E93`)),!await this.promptUserConfirmation(`\u76EE\u6807\u4ED3\u5E93 "${Q}" \u5DF2\u5B58\u5728\u4F46\u662F\u7A7A\u4ED3\u5E93\uFF0C\u662F\u5426\u7EE7\u7EED\u8FC1\u79FB\uFF1F\u8FD9\u5C06\u8986\u76D6\u7A7A\u4ED3\u5E93\u7684\u5185\u5BB9\u3002
\u662F\u5426\u7EE7\u7EED\uFF1F (y/N): `))throw new Error("\u7528\u6237\u53D6\u6D88\u8FC1\u79FB\u64CD\u4F5C");return console.log(K.info("\u7528\u6237\u786E\u8BA4\u7EE7\u7EED\u8FC1\u79FB\u5230\u7A7A\u4ED3\u5E93")),{exists:!0,isEmpty:!0,targetUrl:this.targetGroupUrl.startsWith("https://")?$.http_url_to_repo:$.ssh_url_to_repo}}return{exists:!0,isEmpty:!1}}else if(Y.status===404)return console.log(`\u2705 \u4ED3\u5E93\u4E0D\u5B58\u5728\uFF0C\u53EF\u4EE5\u521B\u5EFA: ${Q}`),{exists:!1};else throw new Error(`\u68C0\u67E5\u4ED3\u5E93\u5B58\u5728\u6027\u5931\u8D25\uFF0CHTTP\u72B6\u6001\u7801: ${Y.status}`)}catch(B){throw console.log(`\u274C \u68C0\u67E5\u4ED3\u5E93\u5B58\u5728\u6027\u65F6\u53D1\u751F\u9519\u8BEF: ${B.message}`),B}}async checkIfRepositoryIsEmpty(Q){try{let B=`${this.getGitLabApiBase()}/projects/${Q}/repository/commits`,X=await fetch(B,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(X.status===200)return(await X.json()).length===0;else if(X.status===404)return!0;return!1}catch(B){return console.log(`\u26A0\uFE0F \u68C0\u67E5\u4ED3\u5E93\u662F\u5426\u4E3A\u7A7A\u65F6\u53D1\u751F\u9519\u8BEF: ${B.message}`),!1}}async promptUserConfirmation(Q){return new Promise((B)=>{let X=h.createInterface({input:process.stdin,output:process.stdout});X.question(Q,(Y)=>{X.close();let $=Y.toLowerCase().trim();B($==="y"||$==="yes")})})}extractRepoNameFromUrl(Q){let B=Q.match(/\/([^\/]+)\.git$/);if(B)return B[1];let X=Q.split("/");return X[X.length-1]}cloneOriginalRepository(Q){if(console.log(`\uD83D\uDD04 \u6B63\u5728\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF: ${Q.name}`),console.log(K.info(`\u539F\u4ED3\u5E93\u5730\u5740: ${K.url(Q.originalUrl)}`)),!J(this.tempDir))k(this.tempDir,{recursive:!0}),console.log(K.dim(`\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55: ${this.tempDir}`));let B=this.extractRepoNameFromUrl(Q.originalUrl),X=new Date().toISOString().replace(/[:.]/g,"-"),Y=Math.random().toString(36).substring(2,6),$=`${B}-${X}-${Y}.git`,A=W.join(this.tempDir,$);if(console.log(K.info(`\u955C\u50CF\u76EE\u5F55: ${K.dim(A)}`)),J(A))console.log(K.warning(`\u5220\u9664\u5DF2\u5B58\u5728\u7684\u955C\u50CF\u76EE\u5F55: ${K.dim(A)}`)),U(A,{recursive:!0,force:!0});console.log(K.progress("\u5F00\u59CB\u514B\u9686\u955C\u50CF..."));let Z=`git clone --mirror ${Q.originalUrl} "${A}"`;return this.executeCommandWithProgress(Z),console.log(K.success(`\u539F\u4ED3\u5E93\u955C\u50CF\u514B\u9686\u5B8C\u6210: ${K.dim(A)}`)),A}async createTargetRepository(Q){try{console.log(K.info(`\u6B63\u5728\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93: ${K.highlight(Q.name)}`));let B=await this.getGroupId(this.targetGroupUrl),X=`${this.getGitLabApiBase()}/projects`,Y={name:Q.name,path:Q.name,description:Q.description||"",namespace_id:B,visibility:"internal",initialize_with_readme:!1,issues_enabled:!0,merge_requests_enabled:!0,wiki_enabled:!0,snippets_enabled:!0},$=await fetch(X,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(Y)});if(!$.ok){let V=await $.text();throw new Error(`\u521B\u5EFA\u4ED3\u5E93\u5931\u8D25\uFF0CHTTP\u72B6\u6001\u7801: ${$.status}\uFF0C\u9519\u8BEF\u4FE1\u606F: ${V}`)}let A=await $.json(),Z=this.targetGroupUrl.startsWith("https://")?A.http_url_to_repo:A.ssh_url_to_repo;return console.log(K.success(`\u76EE\u6807\u4ED3\u5E93\u521B\u5EFA\u5B8C\u6210: ${K.url(Z)}`)),Z}catch(B){throw console.log(K.error(`\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93\u5931\u8D25: ${B.message}`)),B}}pushMirrorToTarget(Q,B){console.log(K.info("\u6B63\u5728\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93...")),console.log(K.info(`\u76EE\u6807\u4ED3\u5E93\u5730\u5740: ${K.url(B)}`)),console.log(K.info(`\u955C\u50CF\u76EE\u5F55: ${K.dim(Q)}`));let X=process.cwd(),Y=[],$=!1;try{console.log(K.progress(`\u5207\u6362\u5230\u955C\u50CF\u76EE\u5F55: ${Q}`)),process.chdir(Q),console.log(K.progress("\u8BBE\u7F6E\u76EE\u6807\u4ED3\u5E93\u8FDC\u7A0B\u5730\u5740..."));let A=`git remote set-url origin "${B}"`;this.executeCommand(A),console.log(K.progress("\u5F00\u59CB\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93..."));let Z="git push --mirror",V=this.executeCommandWithWarningAndProgress(Z);if(V.warning){$=!0;let _=`\u63A8\u9001\u65F6\u9047\u5230\u9690\u85CF\u5F15\u7528\u8B66\u544A: ${V.warning}`;Y.push(_),console.log(K.info("\u955C\u50CF\u63A8\u9001\u5B8C\u6210\uFF08\u5B58\u5728\u8B66\u544A\uFF0C\u4F46\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C\uFF09"))}else console.log(K.success("\u955C\u50CF\u63A8\u9001\u5B8C\u6210"));return{hasWarnings:$,warnings:$?Y:void 0}}finally{console.log(K.progress("\u8FD4\u56DE\u539F\u59CB\u5DE5\u4F5C\u76EE\u5F55")),process.chdir(X)}}async updateRepositoryDescription(Q,B){try{if(console.log(K.info(`\u6B63\u5728\u66F4\u65B0\u4ED3\u5E93\u63CF\u8FF0: ${K.repo(Q)}`)),!B||B.trim()===""){console.log(K.warning("\u63CF\u8FF0\u4E3A\u7A7A\uFF0C\u8DF3\u8FC7\u66F4\u65B0"));return}let Y=`${this.extractGroupPath(this.targetGroupUrl)}/${Q}`,$=`${this.getGitLabApiBase()}/projects/${encodeURIComponent(Y)}`,A={description:B.trim()},Z=await fetch($,{method:"PUT",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(A)});if(!Z.ok){let V=await Z.text();throw new Error(`\u66F4\u65B0\u4ED3\u5E93\u63CF\u8FF0\u5931\u8D25\uFF0CHTTP\u72B6\u6001\u7801: ${Z.status}\uFF0C\u9519\u8BEF\u4FE1\u606F: ${V}`)}console.log(K.success(`\u4ED3\u5E93\u63CF\u8FF0\u66F4\u65B0\u5B8C\u6210: ${K.description(B.trim())}`))}catch(X){throw console.log(K.error(`\u66F4\u65B0\u4ED3\u5E93\u63CF\u8FF0\u5931\u8D25: ${X.message}`)),X}}cloneFinalRepository(Q,B){if(console.log(K.info(`\u6B63\u5728\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93\u5230\u672C\u5730: ${K.repo(B)}`)),console.log(K.info(`\u76EE\u6807\u4ED3\u5E93\u5730\u5740: ${K.url(Q)}`)),console.log(K.info(`\u672C\u5730\u76EE\u5F55: ${K.dim(B)}`)),J(B))console.log(K.warning(`\u5220\u9664\u5DF2\u5B58\u5728\u7684\u76EE\u5F55: ${K.dim(B)}`)),U(B,{recursive:!0,force:!0});console.log(K.progress("\u5F00\u59CB\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93..."));let X=`git clone "${Q}" "${B}"`;this.executeCommandWithProgress(X),console.log(K.success(`\u8FC1\u79FB\u540E\u4ED3\u5E93\u514B\u9686\u5B8C\u6210: ${K.repo(B)}`))}scheduleSaveMigrationLogs(){if(this.saveTimeout)clearTimeout(this.saveTimeout);this.saveTimeout=setTimeout(()=>{this.saveMigrationLogs(),this.saveTimeout=null},2000)}forceSaveMigrationLogs(){if(this.saveTimeout)clearTimeout(this.saveTimeout),this.saveTimeout=null;this.saveMigrationLogs()}updateMigrationLog(Q){if(Q.lastUpdated=new Date().toISOString(),!Q.steps)Q.steps=[];if(!Q.warnings)Q.warnings=[];if(Q.retryCount===void 0)Q.retryCount=0;if(!Q.errorType&&Q.failureReason)Q.errorType="unknown";this.logs.set(Q.projectName,Q),this.scheduleSaveMigrationLogs()}createConfigBackup(){let Q=new Date().toISOString().replace(/[:.]/g,"-"),B=this.moveFilePath.replace(/\.md$/,`.backup.${Q}.md`);try{let X=P(this.moveFilePath,"utf-8");return b(B,X,"utf-8"),console.log(K.dim(`\uD83D\uDCCB \u5DF2\u521B\u5EFA\u914D\u7F6E\u6587\u4EF6\u5907\u4EFD: ${W.basename(B)}`)),B}catch(X){return console.log(K.warning(`\u26A0\uFE0F  \u521B\u5EFA\u5907\u4EFD\u5931\u8D25: ${X instanceof Error?X.message:String(X)}`)),""}}cleanupOldBackups(){try{let Q=W.dirname(this.moveFilePath),B=W.basename(this.moveFilePath,".md"),Y=R(Q).filter(($)=>$.startsWith(`${B}.backup.`)&&$.endsWith(".md")).map(($)=>({name:$,path:W.join(Q,$),time:T(W.join(Q,$)).mtime})).sort(($,A)=>A.time.getTime()-$.time.getTime());if(Y.length>5)Y.slice(5).forEach((A)=>{try{U(A.path),console.log(K.dim(`\uD83D\uDDD1\uFE0F  \u5DF2\u5220\u9664\u65E7\u5907\u4EFD: ${A.name}`))}catch(Z){console.log(K.warning(`\u26A0\uFE0F  \u5220\u9664\u5907\u4EFD\u5931\u8D25: ${A.name}`))}})}catch(Q){console.log(K.dim("\u26A0\uFE0F  \u6E05\u7406\u65E7\u5907\u4EFD\u65F6\u51FA\u73B0\u95EE\u9898\uFF0C\u4F46\u4E0D\u5F71\u54CD\u4E3B\u6D41\u7A0B"))}}cleanupOldTempDirectories(){try{let Q=process.cwd();if(!J(Q)){console.warn(K.warning("\u5F53\u524D\u76EE\u5F55\u4E0D\u5B58\u5728\uFF0C\u8DF3\u8FC7\u4E34\u65F6\u76EE\u5F55\u6E05\u7406"));return}let B=R(Q),X=new Date().getTime(),Y=86400000,$=3600000,A=B.filter((z)=>{try{return z.startsWith("temp-migration-")&&T(W.join(Q,z)).isDirectory()}catch{return!1}}).map((z)=>{let F=W.join(Q,z);try{let v=T(F),E=!1,D=0;try{D=R(F).length,E=D===0}catch(S){console.warn(K.warning(`\u68C0\u67E5\u76EE\u5F55 ${z} \u5185\u5BB9\u65F6\u51FA\u9519: ${S}`))}return{name:z,path:F,time:v.mtime,age:X-v.mtime.getTime(),isEmpty:E,fileCount:D,size:this.getDirectorySize(F)}}catch(v){return console.warn(K.warning(`\u83B7\u53D6\u76EE\u5F55 ${z} \u4FE1\u606F\u65F6\u51FA\u9519: ${v}`)),null}}).filter((z)=>z!==null).sort((z,F)=>F.time.getTime()-z.time.getTime());if(A.length===0){console.log(K.dim("\u672A\u53D1\u73B0\u9700\u8981\u6E05\u7406\u7684\u4E34\u65F6\u76EE\u5F55"));return}console.log(K.info(`\u53D1\u73B0 ${A.length} \u4E2A\u4E34\u65F6\u76EE\u5F55`));let Z=A.filter((z)=>z.isEmpty),V=A.filter((z)=>z.age>Y&&!z.isEmpty),_=A.filter((z)=>z.age>$&&!z.isEmpty),G=A.slice(3).filter((z)=>!z.isEmpty&&z.age<Y),q=[...Z,...V,...G,..._.filter((z)=>!V.includes(z)&&!G.includes(z))],H=Array.from(new Set(q));if(H.length===0){console.log(K.dim("\u6240\u6709\u4E34\u65F6\u76EE\u5F55\u90FD\u5728\u4FDD\u7559\u8303\u56F4\u5185\uFF0C\u65E0\u9700\u6E05\u7406"));return}if(console.log(K.info(`\uD83E\uDDF9 \u51C6\u5907\u6E05\u7406 ${H.length} \u4E2A\u4E34\u65F6\u76EE\u5F55:`)),Z.length>0)console.log(K.dim(`  - ${Z.length} \u4E2A\u7A7A\u76EE\u5F55`));if(V.length>0)console.log(K.dim(`  - ${V.length} \u4E2A\u8D85\u8FC724\u5C0F\u65F6\u7684\u76EE\u5F55`));if(_.length>0)console.log(K.dim(`  - ${_.filter((z)=>!V.includes(z)).length} \u4E2A\u8D85\u8FC71\u5C0F\u65F6\u7684\u76EE\u5F55`));if(G.length>0)console.log(K.dim(`  - ${G.length} \u4E2A\u8D85\u51FA\u4FDD\u7559\u6570\u91CF\u7684\u76EE\u5F55`));let I=0,O=0;if(H.forEach((z)=>{try{let F=Math.round(z.age/$*10)/10,v=z.size>0?` (${this.formatBytes(z.size)})`:" (\u7A7A)",E=F<1?" (\u65B0\u5EFA)":` (${F}h\u524D)`;U(z.path,{recursive:!0,force:!0}),console.log(K.dim(`  \u2713 \u5DF2\u5220\u9664: ${z.name}${v}${E}`)),I++}catch(F){console.warn(K.warning(`  \u2717 \u5220\u9664\u5931\u8D25: ${z.name} - ${F}`)),O++}}),I>0)console.log(K.success(`\u2713 \u6210\u529F\u6E05\u7406 ${I} \u4E2A\u4E34\u65F6\u76EE\u5F55`));if(O>0)console.warn(K.warning(`\u26A0 ${O} \u4E2A\u76EE\u5F55\u6E05\u7406\u5931\u8D25`))}catch(Q){console.warn(K.warning(`\u6E05\u7406\u4E34\u65F6\u76EE\u5F55\u65F6\u51FA\u9519: ${Q}`))}}getDirectorySize(Q){try{let B=0,X=R(Q);for(let Y of X){let $=W.join(Q,Y),A=T($);if(A.isDirectory())B+=this.getDirectorySize($);else B+=A.size}return B}catch(B){return 0}}formatBytes(Q){if(Q===0)return"0 B";let B=1024,X=["B","KB","MB","GB"],Y=Math.floor(Math.log(Q)/Math.log(B));return parseFloat((Q/Math.pow(B,Y)).toFixed(1))+" "+X[Y]}saveMigrationLogs(){try{if(Array.from(this.logs.values()).some((q)=>q.isFinalCloned||q.failureReason))this.createConfigBackup();let B=W.dirname(this.moveFilePath);if(!J(B))k(B,{recursive:!0});let X;if(J(this.moveFilePath))X=P(this.moveFilePath,"utf-8");else console.log("\uD83D\uDCDD move.md \u6587\u4EF6\u4E0D\u5B58\u5728\uFF0C\u521B\u5EFA\u65B0\u7684\u65E5\u5FD7\u6587\u4EF6"),X=`# GitLab \u4ED3\u5E93\u8FC1\u79FB\u914D\u7F6E

## \u65E5\u5FD7`;let Y=X.split(`
`),$=Y.findIndex((q)=>q.includes("## \u65E5\u5FD7")),A;if($===-1)console.log("\uD83D\uDCDD \u672A\u627E\u5230\u65E5\u5FD7\u90E8\u5206\uFF0C\u81EA\u52A8\u521B\u5EFA\u65E5\u5FD7\u90E8\u5206"),A=[...Y,"","## \u65E5\u5FD7"];else A=Y.slice(0,$+1);let Z=[""],V=new Set(this.repositories.map((q)=>q.name)),_=0;for(let q of this.repositories){let H=this.logs.get(q.name);if(H&&V.has(q.name)){if(Z.push(`### ${H.projectName}`),Z.push(`- **\u9879\u76EE\u540D\u79F0**: ${H.projectName}`),Z.push(`- **\u9879\u76EE\u63CF\u8FF0**: ${H.projectDescription}`),Z.push(`- **\u539F\u4ED3\u5E93\u5730\u5740**: ${H.originalRepoUrl}`),Z.push(`- **\u76EE\u6807\u5206\u7EC4**: ${H.targetGroup}`),Z.push(`- **\u76EE\u6807\u4ED3\u5E93\u5730\u5740**: ${H.targetRepoUrl}`),Z.push(`- **\u5F00\u59CB\u65F6\u95F4**: ${H.startTime}`),Z.push(`- **\u7ED3\u675F\u65F6\u95F4**: ${H.endTime}`),Z.push(`- **\u8017\u65F6**: ${H.duration}`),Z.push(`- **\u662F\u5426\u5DF2\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF**: ${H.isOriginalCloned?"\u2705":"\u274C"}`),Z.push(`- **\u662F\u5426\u5DF2\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93**: ${H.isTargetCreated?"\u2705":"\u274C"}`),Z.push(`- **\u662F\u5426\u5DF2\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93**: ${H.isMirrorPushed?"\u2705":"\u274C"}`),Z.push(`- **\u662F\u5426\u5DF2\u4FEE\u6539\u76EE\u6807\u4ED3\u5E93\u7684\u9879\u76EE\u63CF\u8FF0**: ${H.isDescriptionUpdated?"\u2705":"\u274C"}`),Z.push(`- **\u662F\u5426\u5DF2\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93**: ${H.isFinalCloned?"\u2705":"\u274C"}`),H.warnings&&H.warnings.length>0)Z.push(`- **\u8B66\u544A\u539F\u56E0**: ${H.warnings.join("; ")}`);if(H.failureReason)Z.push(`- **\u5931\u8D25\u539F\u56E0**: ${H.failureReason}`);Z.push(""),_++}}let G=[...A,...Z].join(`
`);b(this.moveFilePath,G,"utf-8"),console.log(`\uD83D\uDCBE \u5DF2\u4FDD\u5B58 ${_} \u4E2A\u9879\u76EE\u7684\u8FC1\u79FB\u65E5\u5FD7\uFF0C\u987A\u5E8F\u4E0E\u914D\u7F6E\u6587\u4EF6\u4E00\u81F4`)}catch(Q){console.error(`\u274C \u4FDD\u5B58\u65E5\u5FD7\u5931\u8D25: ${Q.message}`)}}recordMigrationStep(Q,B,X,Y,$,A){let Z=this.logs.get(Q);if(!Z)return;let V=Z.steps.findIndex((G)=>G.name===B),_=new Date().toISOString();if(V>=0){let G=Z.steps[V],q=G.startTime||_;Z.steps[V]={...G,status:X,endTime:X==="completed"||X==="failed"||X==="warning"?_:G.endTime,duration:X==="completed"||X==="failed"||X==="warning"?new Date(_).getTime()-new Date(q).getTime():G.duration,error:Y,errorType:$,warnings:A||G.warnings||[]}}else Z.steps.push({name:B,status:X,startTime:X==="in_progress"?_:void 0,endTime:X==="completed"||X==="failed"||X==="warning"?_:void 0,duration:X==="completed"||X==="failed"||X==="warning"?0:void 0,error:Y,errorType:$,warnings:A||[]});this.updateMigrationLog(Z)}addWarning(Q,B){let X=this.logs.get(Q);if(!X)return;if(!X.warnings.includes(B))X.warnings.push(B),this.updateMigrationLog(X)}classifyError(Q){let B=Q.toLowerCase();if(B.includes("git")||B.includes("clone")||B.includes("push")||B.includes("pull")||B.includes("fetch")||B.includes("remote")||B.includes("repository not found")||B.includes("authentication failed")||B.includes("fatal: not a git repository")||B.includes("fatal: repository")||B.includes("error: failed to push")||B.includes("error: src refspec")||B.includes("error: pathspec")||B.includes("fatal: could not read from remote repository")||B.includes("fatal: unable to access")||B.includes("ssh: connect to host")||B.includes("host key verification failed")||B.includes("permission denied (publickey)")||B.includes("branch not found")||B.includes("ref does not exist")||B.includes("non-fast-forward")||B.includes("merge conflict")||B.includes("working tree clean"))return"git_operation";if(B.includes("api")||B.includes("http")||B.includes("401")||B.includes("403")||B.includes("404")||B.includes("422")||B.includes("500")||B.includes("502")||B.includes("503")||B.includes("unauthorized")||B.includes("forbidden")||B.includes("bad gateway")||B.includes("service unavailable")||B.includes("internal server error")||B.includes("gitlab api")||B.includes("project already exists")||B.includes("name has already been taken")||B.includes("path has already been taken")||B.includes("invalid token")||B.includes("token expired")||B.includes("insufficient scope"))return"api_operation";if(B.includes("network")||B.includes("timeout")||B.includes("connection")||B.includes("dns")||B.includes("enotfound")||B.includes("econnrefused")||B.includes("econnreset")||B.includes("etimedout")||B.includes("socket hang up")||B.includes("network is unreachable")||B.includes("host is unreachable")||B.includes("connection timed out")||B.includes("unable to resolve host")||B.includes("name resolution failed")||B.includes("temporary failure in name resolution"))return"network";if(B.includes("ebusy")||B.includes("resource busy or locked")||B.includes("file is being used by another process")||B.includes("cannot delete")||B.includes("cannot remove")||B.includes("directory not empty")||B.includes("enoent")||B.includes("no such file or directory")||B.includes("eacces")||B.includes("permission denied")||B.includes("eperm")||B.includes("operation not permitted")||B.includes("emfile")||B.includes("too many open files")||B.includes("enospc")||B.includes("no space left on device")||B.includes("disk full")||B.includes("cleanup failed")||B.includes("failed to delete")||B.includes("failed to remove"))return"filesystem";if(B.includes("permission")||B.includes("access")||B.includes("denied")||B.includes("insufficient privileges")||B.includes("not authorized")||B.includes("access forbidden")||B.includes("you are not allowed")||B.includes("insufficient permissions")||B.includes("operation not permitted")||B.includes("access level")||B.includes("maintainer access required")||B.includes("owner access required"))return"permission";if(B.includes("validation")||B.includes("invalid")||B.includes("malformed")||B.includes("format")||B.includes("bad request")||B.includes("unprocessable entity")||B.includes("missing required")||B.includes("field is required")||B.includes("must be")||B.includes("cannot be blank")||B.includes("is too long")||B.includes("is too short")||B.includes("contains invalid characters")||B.includes("url is invalid")||B.includes("email is invalid"))return"validation";return"unknown"}getReadableErrorMessage(Q,B){let X=Q.length>200?Q.substring(0,200)+"...":Q,Y=X.toLowerCase();switch(B){case"git_operation":if(Y.includes("clone"))return`Git \u514B\u9686\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5\u6E90\u4ED3\u5E93\u5730\u5740\u662F\u5426\u6B63\u786E\uFF0C\u7F51\u7EDC\u8FDE\u63A5\u662F\u5426\u6B63\u5E38\u3002`;else if(Y.includes("push"))return`Git \u63A8\u9001\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5\u76EE\u6807\u4ED3\u5E93\u6743\u9650\u548C\u7F51\u7EDC\u8FDE\u63A5\u3002`;else if(Y.includes("fetch"))return`Git \u83B7\u53D6\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5\u4ED3\u5E93\u5730\u5740\u548C\u7F51\u7EDC\u8FDE\u63A5\u3002`;else if(Y.includes("authentication failed"))return`Git \u8BA4\u8BC1\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5 Access Token \u662F\u5426\u6709\u6548\u3002`;else return`Git \u64CD\u4F5C\u5931\u8D25: ${X}`;case"api_operation":if(Y.includes("401"))return`API \u8BA4\u8BC1\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5 Access Token \u662F\u5426\u6709\u6548\u4E14\u5177\u6709\u8DB3\u591F\u6743\u9650\u3002`;else if(Y.includes("403"))return`API \u6743\u9650\u4E0D\u8DB3: ${X}\u3002\u8BF7\u786E\u4FDD Access Token \u5177\u6709\u521B\u5EFA\u4ED3\u5E93\u548C\u7BA1\u7406\u9879\u76EE\u7684\u6743\u9650\u3002`;else if(Y.includes("404"))return`API \u8D44\u6E90\u672A\u627E\u5230: ${X}\u3002\u8BF7\u68C0\u67E5\u76EE\u6807\u5206\u7EC4\u8DEF\u5F84\u662F\u5426\u6B63\u786E\u3002`;else if(Y.includes("409"))return`API \u8D44\u6E90\u51B2\u7A81: ${X}\u3002\u76EE\u6807\u4ED3\u5E93\u53EF\u80FD\u5DF2\u5B58\u5728\uFF0C\u8BF7\u68C0\u67E5\u4ED3\u5E93\u540D\u79F0\u3002`;else if(Y.includes("422"))return`API \u53C2\u6570\u9A8C\u8BC1\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5\u4ED3\u5E93\u540D\u79F0\u548C\u63CF\u8FF0\u662F\u5426\u7B26\u5408\u8981\u6C42\u3002`;else if(Y.includes("500"))return`API \u670D\u52A1\u5668\u9519\u8BEF: ${X}\u3002GitLab \u670D\u52A1\u5668\u53EF\u80FD\u6682\u65F6\u4E0D\u53EF\u7528\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5\u3002`;else return`API \u8C03\u7528\u5931\u8D25: ${X}`;case"network":if(Y.includes("timeout"))return`\u7F51\u7EDC\u8D85\u65F6: ${X}\u3002\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u6216\u7A0D\u540E\u91CD\u8BD5\u3002`;else if(Y.includes("enotfound")||Y.includes("getaddrinfo"))return`DNS \u89E3\u6790\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u548C GitLab \u670D\u52A1\u5668\u5730\u5740\u3002`;else if(Y.includes("econnrefused"))return`\u8FDE\u63A5\u88AB\u62D2\u7EDD: ${X}\u3002\u8BF7\u68C0\u67E5 GitLab \u670D\u52A1\u5668\u662F\u5426\u53EF\u8BBF\u95EE\u3002`;else return`\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u72B6\u6001\u3002`;case"permission":if(Y.includes("access denied"))return`\u8BBF\u95EE\u88AB\u62D2\u7EDD: ${X}\u3002\u8BF7\u68C0\u67E5 Access Token \u6743\u9650\u6216\u8054\u7CFB\u7BA1\u7406\u5458\u3002`;else if(Y.includes("insufficient privileges"))return`\u6743\u9650\u4E0D\u8DB3: ${X}\u3002\u8BF7\u786E\u4FDD\u5177\u6709\u76EE\u6807\u5206\u7EC4\u7684\u521B\u5EFA\u4ED3\u5E93\u6743\u9650\u3002`;else return`\u6743\u9650\u4E0D\u8DB3: ${X}\u3002\u8BF7\u68C0\u67E5\u76F8\u5173\u6743\u9650\u8BBE\u7F6E\u3002`;case"validation":if(Y.includes("invalid repository name"))return`\u4ED3\u5E93\u540D\u79F0\u65E0\u6548: ${X}\u3002\u8BF7\u4F7F\u7528\u6709\u6548\u7684\u4ED3\u5E93\u540D\u79F0\u683C\u5F0F\u3002`;else if(Y.includes("invalid group path"))return`\u5206\u7EC4\u8DEF\u5F84\u65E0\u6548: ${X}\u3002\u8BF7\u68C0\u67E5\u76EE\u6807\u5206\u7EC4\u8DEF\u5F84\u683C\u5F0F\u3002`;else return`\u6570\u636E\u9A8C\u8BC1\u5931\u8D25: ${X}\u3002\u8BF7\u68C0\u67E5\u8F93\u5165\u53C2\u6570\u7684\u683C\u5F0F\u548C\u6709\u6548\u6027\u3002`;case"filesystem":if(Y.includes("ebusy")||Y.includes("resource busy or locked"))return`\u6587\u4EF6\u7CFB\u7EDF\u5FD9\u788C: ${X}\u3002\u6587\u4EF6\u6B63\u88AB\u5176\u4ED6\u8FDB\u7A0B\u4F7F\u7528\uFF0C\u8FD9\u901A\u5E38\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C\u3002`;else if(Y.includes("cannot delete")||Y.includes("cannot remove"))return`\u6587\u4EF6\u5220\u9664\u5931\u8D25: ${X}\u3002\u4E34\u65F6\u6587\u4EF6\u6E05\u7406\u5931\u8D25\uFF0C\u4F46\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C\u3002`;else if(Y.includes("enoent")||Y.includes("no such file or directory"))return`\u6587\u4EF6\u4E0D\u5B58\u5728: ${X}\u3002\u76EE\u6807\u6587\u4EF6\u53EF\u80FD\u5DF2\u88AB\u5220\u9664\uFF0C\u8FD9\u901A\u5E38\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C\u3002`;else if(Y.includes("enospc")||Y.includes("no space left on device"))return`\u78C1\u76D8\u7A7A\u95F4\u4E0D\u8DB3: ${X}\u3002\u8BF7\u6E05\u7406\u78C1\u76D8\u7A7A\u95F4\u540E\u91CD\u8BD5\u3002`;else return`\u6587\u4EF6\u7CFB\u7EDF\u9519\u8BEF: ${X}\u3002\u8FD9\u901A\u5E38\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C\uFF0C\u53EF\u4EE5\u5FFD\u7565\u3002`;default:return`\u672A\u77E5\u9519\u8BEF: ${X}\u3002\u5982\u679C\u95EE\u9898\u6301\u7EED\u5B58\u5728\uFF0C\u8BF7\u8054\u7CFB\u6280\u672F\u652F\u6301\u3002`}}async performPreChecks(){let Q=[];console.log("\uD83D\uDD0D \u5F00\u59CB\u6267\u884C\u9884\u68C0\u67E5...");try{console.log("1. \u68C0\u67E5\u7F51\u7EDC\u8FDE\u901A\u6027...");let B=await this.checkNetworkConnectivity();if(!B.success)Q.push(`\u7F51\u7EDC\u8FDE\u901A\u6027\u68C0\u67E5\u5931\u8D25: ${B.error}`);else console.log("\u2713 \u7F51\u7EDC\u8FDE\u901A\u6027\u6B63\u5E38");console.log("2. \u9A8C\u8BC1 GitLab API \u6743\u9650...");let X=await this.checkGitLabApiPermissions();if(!X.success)Q.push(`GitLab API \u6743\u9650\u9A8C\u8BC1\u5931\u8D25: ${X.error}`);else console.log("\u2713 GitLab API \u6743\u9650\u9A8C\u8BC1\u901A\u8FC7");console.log("3. \u9A8C\u8BC1\u76EE\u6807\u5206\u7EC4\u8BBF\u95EE\u6743\u9650...");let Y=await this.checkTargetGroupPermissions();if(!Y.success)Q.push(`\u76EE\u6807\u5206\u7EC4\u6743\u9650\u9A8C\u8BC1\u5931\u8D25: ${Y.error}`);else console.log("\u2713 \u76EE\u6807\u5206\u7EC4\u6743\u9650\u9A8C\u8BC1\u901A\u8FC7");console.log("4. \u68C0\u67E5\u672C\u5730 Git \u73AF\u5883...");let $=await this.checkLocalGitEnvironment();if(!$.success)Q.push(`\u672C\u5730 Git \u73AF\u5883\u68C0\u67E5\u5931\u8D25: ${$.error}`);else console.log("\u2713 \u672C\u5730 Git \u73AF\u5883\u6B63\u5E38");let A=Q.length===0;if(A)console.log("\u2705 \u6240\u6709\u9884\u68C0\u67E5\u9879\u76EE\u901A\u8FC7\uFF0C\u53EF\u4EE5\u5F00\u59CB\u8FC1\u79FB");else console.log("\u274C \u9884\u68C0\u67E5\u53D1\u73B0\u95EE\u9898\uFF0C\u8BF7\u89E3\u51B3\u540E\u91CD\u8BD5"),Q.forEach((Z)=>console.log(`  - ${Z}`));return{success:A,errors:Q}}catch(B){let X=B instanceof Error?B.message:String(B);return Q.push(`\u9884\u68C0\u67E5\u8FC7\u7A0B\u4E2D\u53D1\u751F\u5F02\u5E38: ${X}`),{success:!1,errors:Q}}}async checkNetworkConnectivity(){try{let Q=new URL(this.targetGroupUrl).hostname,B=await fetch(`https://${Q}/api/v4/version`,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`},signal:AbortSignal.timeout(1e4)});if(!B.ok)return{success:!1,error:`\u65E0\u6CD5\u8FDE\u63A5\u5230 GitLab \u670D\u52A1\u5668 (${B.status})`};return{success:!0}}catch(Q){return{success:!1,error:`\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25: ${Q instanceof Error?Q.message:String(Q)}`}}}async checkGitLabApiPermissions(){try{let Q=`${this.getGitLabApiBase()}/user`,B=await fetch(Q,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(!B.ok)if(B.status===401)return{success:!1,error:"Access Token \u65E0\u6548\u6216\u5DF2\u8FC7\u671F"};else if(B.status===403)return{success:!1,error:"Access Token \u6743\u9650\u4E0D\u8DB3"};else return{success:!1,error:`API \u8C03\u7528\u5931\u8D25 (${B.status})`};let X=await B.json();return console.log(`  \u5F53\u524D\u7528\u6237: ${X.name} (${X.username})`),{success:!0}}catch(Q){return{success:!1,error:`API \u6743\u9650\u9A8C\u8BC1\u5931\u8D25: ${Q instanceof Error?Q.message:String(Q)}`}}}async checkTargetGroupPermissions(){try{let Q=await this.getGroupId(this.targetGroupUrl),B=`${this.getGitLabApiBase()}/groups/${Q}`,X=await fetch(B,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(!X.ok)if(X.status===404)return{success:!1,error:"\u76EE\u6807\u5206\u7EC4\u4E0D\u5B58\u5728\u6216\u65E0\u8BBF\u95EE\u6743\u9650"};else if(X.status===403)return{success:!1,error:"\u5BF9\u76EE\u6807\u5206\u7EC4\u6CA1\u6709\u8DB3\u591F\u7684\u6743\u9650"};else return{success:!1,error:`\u5206\u7EC4\u6743\u9650\u68C0\u67E5\u5931\u8D25 (${X.status})`};let Y=await X.json();if(console.log(`  \u76EE\u6807\u5206\u7EC4: ${Y.name} (${Y.full_path})`),Y.permissions&&Y.permissions.group_access){if(Y.permissions.group_access.access_level<30)return{success:!1,error:"\u5728\u76EE\u6807\u5206\u7EC4\u4E2D\u6CA1\u6709\u521B\u5EFA\u9879\u76EE\u7684\u6743\u9650\uFF08\u9700\u8981 Developer \u53CA\u4EE5\u4E0A\u6743\u9650\uFF09"}}return{success:!0}}catch(Q){return{success:!1,error:`\u5206\u7EC4\u6743\u9650\u9A8C\u8BC1\u5931\u8D25: ${Q instanceof Error?Q.message:String(Q)}`}}}async checkLocalGitEnvironment(){try{try{this.executeCommand("git --version")}catch(Q){return{success:!1,error:"Git \u672A\u5B89\u88C5\u6216\u4E0D\u5728 PATH \u73AF\u5883\u53D8\u91CF\u4E2D"}}try{let Q=this.executeCommand("git config --global user.name").trim(),B=this.executeCommand("git config --global user.email").trim();if(!Q||!B)return{success:!1,error:'Git \u7528\u6237\u4FE1\u606F\u672A\u914D\u7F6E\uFF0C\u8BF7\u8FD0\u884C: git config --global user.name "Your Name" \u548C git config --global user.email "your.email@example.com"'};console.log(`  Git \u7528\u6237: ${Q} <${B}>`)}catch(Q){return{success:!1,error:"Git \u914D\u7F6E\u68C0\u67E5\u5931\u8D25"}}try{if(!J(this.tempDir))k(this.tempDir,{recursive:!0});let Q=W.join(this.tempDir,"test-write-permission.tmp");b(Q,"test"),U(Q)}catch(Q){return{success:!1,error:`\u4E34\u65F6\u76EE\u5F55\u6743\u9650\u4E0D\u8DB3: ${this.tempDir}`}}return{success:!0}}catch(Q){return{success:!1,error:`Git \u73AF\u5883\u68C0\u67E5\u5931\u8D25: ${Q instanceof Error?Q.message:String(Q)}`}}}shouldRetry(Q,B){let X=this.getMaxRetries(Q);return B<X}getMaxRetries(Q){return{network:3,api_operation:2,git_operation:1,permission:0,validation:0,filesystem:0,unknown:1}[Q]}getRetryDelay(Q){return Math.min(1000*Math.pow(2,Q),8000)}analyzeMigrationState(Q){let B=[],X="\u5F00\u59CB\u8FC1\u79FB",Y=!0,$=!1;if(Q.isFinalCloned&&!Q.failureReason)return{nextStep:"\u5DF2\u5B8C\u6210",canResume:!1,needsCleanup:!1,recommendations:["\u8FC1\u79FB\u5DF2\u5B8C\u6210\uFF0C\u65E0\u9700\u64CD\u4F5C"]};if(Q.failureReason){let A=Q.errorType||"unknown";if(this.shouldRetry(A,Q.retryCount||0))switch(B.push(`\u53EF\u4EE5\u91CD\u8BD5\uFF0C\u5F53\u524D\u91CD\u8BD5\u6B21\u6570: ${Q.retryCount||0}`),A){case"network":B.push("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u5EFA\u8BAE\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u540E\u91CD\u8BD5");break;case"api_operation":B.push("API \u9519\u8BEF\uFF0C\u5EFA\u8BAE\u68C0\u67E5 Access Token \u6743\u9650");break;case"git_operation":B.push("Git \u64CD\u4F5C\u9519\u8BEF\uFF0C\u5EFA\u8BAE\u68C0\u67E5\u4ED3\u5E93\u5730\u5740\u548C\u6743\u9650"),$=!0;break}else B.push("\u5DF2\u8FBE\u5230\u6700\u5927\u91CD\u8BD5\u6B21\u6570\uFF0C\u5EFA\u8BAE\u624B\u52A8\u68C0\u67E5\u95EE\u9898"),Y=!1}if(!Q.isOriginalCloned)X="\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF";else if(!Q.isTargetCreated)X="\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93";else if(!Q.isMirrorPushed)X="\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93";else if(!Q.isDescriptionUpdated)X="\u66F4\u65B0\u4ED3\u5E93\u63CF\u8FF0";else if(!Q.isFinalCloned)X="\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93";return{nextStep:X,canResume:Y,needsCleanup:$,recommendations:B}}showResumeReport(){let Q=Array.from(this.logs.values()).filter((B)=>!B.isFinalCloned||B.failureReason);if(Q.length===0){console.log(K.success("\u2705 \u6CA1\u6709\u9700\u8981\u65AD\u70B9\u7EED\u4F20\u7684\u9879\u76EE\uFF0C\u6240\u6709\u9879\u76EE\u72B6\u6001\u6B63\u5E38"));return}console.log(`
`+K.info("\uD83D\uDCCB \u65AD\u70B9\u7EED\u4F20\u72B6\u6001\u62A5\u544A:")),console.log(K.separator(80));for(let B of Q){let X=this.analyzeMigrationState(B);if(console.log(`
\uD83D\uDCE6 \u9879\u76EE: ${K.highlight(B.projectName)}`),console.log(`   \u72B6\u6001: ${X.canResume?K.warning("\u53EF\u7EE7\u7EED"):K.error("\u9700\u8981\u624B\u52A8\u5904\u7406")}`),console.log(`   \u4E0B\u4E00\u6B65: ${K.info(X.nextStep)}`),B.retryCount&&B.retryCount>0)console.log(`   \u91CD\u8BD5\u6B21\u6570: ${K.dim(B.retryCount.toString())}`);if(B.failureReason)console.log(`   \u5931\u8D25\u539F\u56E0: ${K.error(B.failureReason)}`);if(X.recommendations.length>0)console.log("   \u5EFA\u8BAE:"),X.recommendations.forEach((Y)=>{console.log(`     - ${K.dim(Y)}`)})}console.log(K.separator(80))}async migrateSingleRepository(Q){console.log(`
`+K.separator(60)),console.log(K.progress(`\u5F00\u59CB\u8FC1\u79FB\u4ED3\u5E93: ${K.highlight(Q.name)}`)),console.log(K.description(`\u9879\u76EE\u63CF\u8FF0: ${Q.description}`)),console.log(K.url(`\u539F\u4ED3\u5E93\u5730\u5740: ${Q.originalUrl}`)),console.log(K.separator(60));let B=this.logs.get(Q.name);if(B){if(console.log(K.info("\u53D1\u73B0\u73B0\u6709\u65E5\u5FD7\u8BB0\u5F55\uFF0C\u68C0\u67E5\u8FC1\u79FB\u72B6\u6001...")),B.isFinalCloned&&!B.failureReason){console.log(K.success(`\u4ED3\u5E93 ${K.highlight(Q.name)} \u5DF2\u5B8C\u6210\u8FC1\u79FB\uFF0C\u8DF3\u8FC7`));return}console.log(K.info("\u7EE7\u7EED\u672A\u5B8C\u6210\u7684\u8FC1\u79FB\u6B65\u9AA4..."))}else{let Y=new Date;B={projectName:Q.name,projectDescription:Q.description,originalRepoUrl:Q.originalUrl,targetGroup:this.targetGroupUrl,targetRepoUrl:"",startTime:Y.toISOString(),endTime:"",duration:"",isOriginalCloned:!1,isTargetCreated:!1,isMirrorPushed:!1,isDescriptionUpdated:!1,isFinalCloned:!1,failureReason:"",steps:[],warnings:[],retryCount:0,lastUpdated:new Date().toISOString()}}let X=B.startTime?new Date(B.startTime):new Date;if(!B.startTime)B.startTime=X.toISOString();try{if(B.failureReason&&!B.isFinalCloned)B.failureReason="";let Y=null;if(!B.isTargetCreated){let V=B.steps.find((_)=>_.name==="\u68C0\u67E5\u76EE\u6807\u4ED3\u5E93");if(V&&V.status==="completed")console.log(K.success("\u76EE\u6807\u4ED3\u5E93\u68C0\u67E5\u5DF2\u5B8C\u6210\uFF0C\u8DF3\u8FC7"));else{this.recordMigrationStep(Q.name,"\u68C0\u67E5\u76EE\u6807\u4ED3\u5E93","in_progress");try{if(Y=await this.checkRepositoryExists(Q.name),Y.exists&&!Y.isEmpty){B.failureReason="\u76EE\u6807\u5206\u7EC4\u4E2D\u5DF2\u5B58\u5728\u540C\u540D\u4ED3\u5E93",this.recordMigrationStep(Q.name,"\u68C0\u67E5\u76EE\u6807\u4ED3\u5E93","failed",B.failureReason,"validation"),console.log(K.error(`\u8FC1\u79FB\u5931\u8D25: ${B.failureReason}`)),this.updateMigrationLog(B);return}this.recordMigrationStep(Q.name,"\u68C0\u67E5\u76EE\u6807\u4ED3\u5E93","completed")}catch(_){let G=_.message,q=this.classifyError(G);throw this.recordMigrationStep(Q.name,"\u68C0\u67E5\u76EE\u6807\u4ED3\u5E93","failed",G,q),_}}}else{let V=B.steps.find((_)=>_.name==="\u68C0\u67E5\u76EE\u6807\u4ED3\u5E93");if(!V||V.status!=="completed")this.recordMigrationStep(Q.name,"\u68C0\u67E5\u76EE\u6807\u4ED3\u5E93","skipped");else console.log(K.success("\u76EE\u6807\u4ED3\u5E93\u68C0\u67E5\u5DF2\u5B8C\u6210\uFF0C\u8DF3\u8FC7"))}let A=`${this.extractRepoNameFromUrl(Q.originalUrl)}.git`;if(!B.isOriginalCloned){console.log(K.step(1,"\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF")),this.recordMigrationStep(Q.name,"\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF","in_progress");try{A=this.cloneOriginalRepository(Q),B.isOriginalCloned=!0,this.recordMigrationStep(Q.name,"\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF","completed"),this.updateMigrationLog(B)}catch(V){let _=V.message,G=this.classifyError(_);throw this.recordMigrationStep(Q.name,"\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF","failed",_,G),V}}else{console.log(K.success(`\u539F\u4ED3\u5E93\u955C\u50CF\u5DF2\u514B\u9686\uFF0C\u8DF3\u8FC7: ${K.dim(A)}`));let V=B.steps.find((_)=>_.name==="\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF");if(!V||V.status!=="completed")this.recordMigrationStep(Q.name,"\u514B\u9686\u539F\u4ED3\u5E93\u955C\u50CF","skipped")}if(!B.isTargetCreated)if(Y&&Y.exists&&Y.isEmpty&&Y.targetUrl)console.log(K.step(2,"\u4F7F\u7528\u73B0\u6709\u7A7A\u4ED3\u5E93")),this.recordMigrationStep(Q.name,"\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93","in_progress"),B.targetRepoUrl=Y.targetUrl,B.isTargetCreated=!0,this.recordMigrationStep(Q.name,"\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93","completed"),this.updateMigrationLog(B);else{console.log(K.step(2,"\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93")),this.recordMigrationStep(Q.name,"\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93","in_progress");try{let V=await this.createTargetRepository(Q);B.targetRepoUrl=V,B.isTargetCreated=!0,this.recordMigrationStep(Q.name,"\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93","completed"),this.updateMigrationLog(B)}catch(V){let _=V.message,G=this.classifyError(_);throw this.recordMigrationStep(Q.name,"\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93","failed",_,G),V}}else{console.log(K.success(`\u76EE\u6807\u4ED3\u5E93\u5DF2\u521B\u5EFA\uFF0C\u8DF3\u8FC7: ${K.dim(B.targetRepoUrl)}`));let V=B.steps.find((_)=>_.name==="\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93");if(!V||V.status!=="completed")this.recordMigrationStep(Q.name,"\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93","skipped")}if(!B.isDescriptionUpdated){console.log(K.step(3,"\u8BBE\u7F6E\u4ED3\u5E93\u63CF\u8FF0")),this.recordMigrationStep(Q.name,"\u8BBE\u7F6E\u4ED3\u5E93\u63CF\u8FF0","in_progress");try{await this.updateRepositoryDescription(Q.name,Q.description),B.isDescriptionUpdated=!0,this.recordMigrationStep(Q.name,"\u8BBE\u7F6E\u4ED3\u5E93\u63CF\u8FF0","completed"),this.updateMigrationLog(B)}catch(V){let _=V.message,G=this.classifyError(_);throw this.recordMigrationStep(Q.name,"\u8BBE\u7F6E\u4ED3\u5E93\u63CF\u8FF0","failed",_,G),V}}else{console.log(K.success("\u4ED3\u5E93\u63CF\u8FF0\u5DF2\u66F4\u65B0\uFF0C\u8DF3\u8FC7"));let V=B.steps.find((_)=>_.name==="\u8BBE\u7F6E\u4ED3\u5E93\u63CF\u8FF0");if(!V||V.status!=="completed")this.recordMigrationStep(Q.name,"\u8BBE\u7F6E\u4ED3\u5E93\u63CF\u8FF0","skipped")}if(!B.isMirrorPushed){console.log(K.step(4,"\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93")),this.recordMigrationStep(Q.name,"\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93","in_progress");try{let V=this.pushMirrorToTarget(A,B.targetRepoUrl);if(B.isMirrorPushed=!0,V.hasWarnings)this.recordMigrationStep(Q.name,"\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93","warning",void 0,void 0,V.warnings),V.warnings?.forEach((_)=>this.addWarning(Q.name,_));else this.recordMigrationStep(Q.name,"\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93","completed");this.updateMigrationLog(B)}catch(V){let _=V.message,G=this.classifyError(_);if(_.includes("deny updating a hidden ref")||_.includes("refs/keep-around")||_.includes("refs/merge-requests")||_.includes("refs/pipelines")||_.includes("refs/environments")||_.includes("refs/heads/")||_.includes("refs/tags/")||_.includes("hidden ref")||_.includes("refusing to update checked out branch")||_.includes("remote rejected")||_.includes("pre-receive hook declined")||_.includes("! [remote rejected]")||_.includes("hook declined")||_.includes("protected branch")||_.includes("To ")||_.includes("Everything up-to-date")||_.includes("non-fast-forward")||_.includes("failed to push some refs")||_.includes("updates were rejected")||_.includes("fetch first")||_.includes("hint: Updates were rejected")||_.includes("error: failed to push"))console.log(K.warning("\u26A0\uFE0F  \u63A8\u9001\u8FC7\u7A0B\u4E2D\u9047\u5230\u9690\u85CF\u5F15\u7528\u76F8\u5173\u8B66\u544A\uFF0C\u4F46\u4E0D\u5F71\u54CD\u8FC1\u79FB\u7ED3\u679C")),B.isMirrorPushed=!0,this.recordMigrationStep(Q.name,"\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93","warning",void 0,void 0,[`\u63A8\u9001\u8FC7\u7A0B\u4E2D\u9047\u5230\u9690\u85CF\u5F15\u7528\u76F8\u5173\u8B66\u544A: ${_}`]),this.addWarning(Q.name,`\u63A8\u9001\u8FC7\u7A0B\u4E2D\u9047\u5230\u9690\u85CF\u5F15\u7528\u76F8\u5173\u8B66\u544A: ${_}`),this.updateMigrationLog(B);else throw this.recordMigrationStep(Q.name,"\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93","failed",_,G),V}}else{console.log(K.success("\u955C\u50CF\u5DF2\u63A8\u9001\uFF0C\u8DF3\u8FC7"));let V=B.steps.find((_)=>_.name==="\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93");if(!V||V.status!=="completed"&&V.status!=="warning")this.recordMigrationStep(Q.name,"\u63A8\u9001\u955C\u50CF\u5230\u76EE\u6807\u4ED3\u5E93","skipped")}if(this.skipFinalClone)console.log(K.warning("\u5DF2\u7981\u7528\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93\uFF0C\u8DF3\u8FC7")),this.recordMigrationStep(Q.name,"\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93","skipped"),B.isFinalCloned=!0;else if(!B.isFinalCloned){console.log(K.step(5,"\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93\u5230\u672C\u5730")),this.recordMigrationStep(Q.name,"\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93","in_progress");try{this.cloneFinalRepository(B.targetRepoUrl,Q.name),B.isFinalCloned=!0,this.recordMigrationStep(Q.name,"\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93","completed")}catch(V){let _=V.message,G=this.classifyError(_);if(_.includes("deny updating a hidden ref")||_.includes("refs/keep-around")||_.includes("hidden ref"))console.log(K.warning(`\u514B\u9686\u8FC7\u7A0B\u4E2D\u9047\u5230\u9690\u85CF\u5F15\u7528\u8B66\u544A: ${_}`)),this.addWarning(Q.name,`\u514B\u9686\u65F6\u9047\u5230\u9690\u85CF\u5F15\u7528\u8B66\u544A: ${_}`),this.recordMigrationStep(Q.name,"\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93","warning",void 0,void 0,[_]),B.isFinalCloned=!0;else throw this.recordMigrationStep(Q.name,"\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93","failed",_,G),V}}else{console.log(K.success("\u8FC1\u79FB\u540E\u4ED3\u5E93\u5DF2\u514B\u9686\uFF0C\u8DF3\u8FC7"));let V=B.steps.find((_)=>_.name==="\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93");if(!V||V.status!=="completed")this.recordMigrationStep(Q.name,"\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93","skipped")}if(J(A))U(A,{recursive:!0,force:!0}),console.log(K.dim(`\uD83D\uDDD1\uFE0F  \u5DF2\u6E05\u7406\u955C\u50CF\u76EE\u5F55: ${W.basename(A)}`));let Z=new Date;if(B.endTime=Z.toISOString(),B.duration=`${Math.round((Z.getTime()-X.getTime())/1000)}\u79D2`,this.updateMigrationLog(B),console.log(`
`+K.success(`\u4ED3\u5E93\u8FC1\u79FB\u5B8C\u6210: ${K.highlight(Q.name)} ${K.duration(`(\u8017\u65F6: ${B.duration})`)}`)+`
`),B.warnings&&B.warnings.length>0)console.log(K.warning(`\u26A0\uFE0F \u8B66\u544A\u4FE1\u606F: ${B.warnings.length} \u6761`))}catch(Y){let $=new Date,A=Y.message,Z=this.classifyError(A);B.errorType=Z,B.retryCount=(B.retryCount||0)+1;let V=this.getReadableErrorMessage(A,Z);if(this.shouldRetry(Z,B.retryCount)){let _=this.getRetryDelay(B.retryCount-1),G=this.getMaxRetries(Z);console.log(`
`+K.warning("\u26A0\uFE0F \u8FC1\u79FB\u9047\u5230\u9519\u8BEF\uFF0C\u51C6\u5907\u91CD\u8BD5...")),console.log(K.error(`\u9519\u8BEF: ${V}`)),console.log(K.dim(`\u9519\u8BEF\u7C7B\u578B: ${Z}`)),console.log(K.info(`\u91CD\u8BD5\u8FDB\u5EA6: ${B.retryCount}/${G}`)),console.log(K.info(`\u7B49\u5F85 ${_/1000} \u79D2\u540E\u91CD\u8BD5...`)),this.recordMigrationStep(Q.name,`\u51C6\u5907\u91CD\u8BD5 (${B.retryCount}/${G})`,"in_progress",`\u7B49\u5F85 ${_/1000} \u79D2`),this.updateMigrationLog(B);try{if(J(this.tempDir)){let q=R(this.tempDir),H=this.extractRepoNameFromUrl(Q.originalUrl);q.filter((O)=>O.startsWith(H)&&O.endsWith(".git")).forEach((O)=>{let z=W.join(this.tempDir,O);if(J(z))U(z,{recursive:!0,force:!0}),console.log(K.dim(`\uD83D\uDDD1\uFE0F  \u5DF2\u6E05\u7406\u955C\u50CF\u76EE\u5F55: ${O}`))})}}catch(q){console.log(K.warning("\u26A0\uFE0F  \u6E05\u7406\u955C\u50CF\u76EE\u5F55\u65F6\u51FA\u73B0\u95EE\u9898"))}return await new Promise((q)=>setTimeout(q,_)),B.failureReason="",console.log(K.info(`\uD83D\uDD04 \u5F00\u59CB\u7B2C ${B.retryCount} \u6B21\u91CD\u8BD5: ${K.highlight(Q.name)}`)),await this.migrateSingleRepository(Q)}else{B.endTime=$.toISOString(),B.duration=`${Math.round(($.getTime()-X.getTime())/1000)}\u79D2`,B.failureReason=V,this.recordMigrationStep(Q.name,"\u8FC1\u79FB\u6700\u7EC8\u5931\u8D25","failed",B.failureReason,Z),this.updateMigrationLog(B),console.log(`
`+K.error(`\u274C \u4ED3\u5E93\u8FC1\u79FB\u6700\u7EC8\u5931\u8D25: ${K.highlight(Q.name)}`)),console.log(K.error(`\u5931\u8D25\u539F\u56E0: ${B.failureReason}`)),console.log(K.error(`\u9519\u8BEF\u7C7B\u578B: ${Z}`)),console.log(K.error(`\u603B\u91CD\u8BD5\u6B21\u6570: ${B.retryCount}`));let _=this.analyzeMigrationState(B);if(_.recommendations.length>0)console.log(K.info("\uD83D\uDCA1 \u5EFA\u8BAE:")),_.recommendations.forEach((H)=>{console.log(K.dim(`   - ${H}`))});let q=`${this.extractRepoNameFromUrl(Q.originalUrl)}.git`;if(J(q))U(q,{recursive:!0,force:!0})}}}async migrate(){try{if(console.log(`
`+K.box("GitLab \u9879\u76EE\u8FC1\u79FB\u5DE5\u5177")),console.log(""),this.parseMoveFile(),!this.accessToken||this.accessToken==="your_access_token"||this.accessToken==="your_gitlab_access_token"){if(console.log(K.warning("\u672A\u627E\u5230\u6709\u6548\u7684 GitLab Access Token")),console.log(K.info("Access Token \u83B7\u53D6\u4F18\u5148\u7EA7:")),console.log(K.dim("   1. \u547D\u4EE4\u884C\u53C2\u6570 (\u6700\u9AD8\u4F18\u5148\u7EA7)")),console.log(K.dim('   2. move.md \u6587\u4EF6\u4E2D\u7684 "## \u8FC1\u79FB\u76EE\u6807 Access Token" \u90E8\u5206')),console.log(K.dim("   3. \u73AF\u5883\u53D8\u91CF: GITLAB_ACCESS_TOKEN")),console.log(K.dim("   4. \u4EA4\u4E92\u5F0F\u8F93\u5165 (\u5F53\u524D)")),console.log(""),this.accessToken=await y(),!this.accessToken||this.accessToken.trim()==="")throw console.error(K.error("Access Token \u4E0D\u80FD\u4E3A\u7A7A")),new Error("Access Token \u4E0D\u80FD\u4E3A\u7A7A")}this.showResumeReport();let Q=await this.performPreChecks();if(!Q.success)throw console.error(`
`+K.error("\u274C \u9884\u68C0\u67E5\u5931\u8D25\uFF0C\u65E0\u6CD5\u5F00\u59CB\u8FC1\u79FB:")),Q.errors.forEach((X)=>console.error(K.error(`  - ${X}`))),console.log(K.warning(`
\uD83E\uDDF9 \u9884\u68C0\u67E5\u5931\u8D25\uFF0C\u6B63\u5728\u6E05\u7406\u53EF\u80FD\u7684\u4E34\u65F6\u6587\u4EF6...`)),j(this),await new Promise((X)=>setTimeout(X,100)),new Error("\u9884\u68C0\u67E5\u5931\u8D25\uFF0C\u8BF7\u89E3\u51B3\u4E0A\u8FF0\u95EE\u9898\u540E\u91CD\u8BD5");let B=this.repositories;if(this.selectedProjects.length>0){B=this.repositories.filter((Y)=>this.selectedProjects.includes(Y.name)),console.log(K.info(`\u6307\u5B9A\u8FC1\u79FB\u9879\u76EE: ${K.highlight(this.selectedProjects.join(", "))}`)),console.log(K.success(`\u627E\u5230\u5339\u914D\u9879\u76EE: ${K.highlight(B.map((Y)=>Y.name).join(", "))}`));let X=this.selectedProjects.filter((Y)=>!this.repositories.some(($)=>$.name===Y));if(X.length>0)console.log(K.warning(`\u672A\u627E\u5230\u7684\u9879\u76EE: ${X.join(", ")}`))}if(B.length===0){console.log(K.warning("\u6CA1\u6709\u627E\u5230\u9700\u8981\u8FC1\u79FB\u7684\u4ED3\u5E93"));return}console.log(`
`+K.progress(`\u5F00\u59CB\u8FC1\u79FB ${K.highlight(B.length.toString())} \u4E2A\u4ED3\u5E93`)),console.log(K.separator(60));for(let X of B)await this.migrateSingleRepository(X);console.log(`
`+K.separator(60)),console.log(K.success("\uD83C\uDF89 \u6240\u6709\u8FC1\u79FB\u4EFB\u52A1\u5B8C\u6210"))}catch(Q){console.error(K.error(`\u8FC1\u79FB\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF: ${Q.message}`)),process.exit(1)}}generateMigrationReport(){let B=(this.selectedProjects.length>0?this.repositories.filter((q)=>this.selectedProjects.includes(q.name)):this.repositories).map((q)=>q.name),X=Array.from(this.logs.values()).filter((q)=>B.includes(q.projectName)),Y=X.length,$=X.filter((q)=>q.isFinalCloned&&!q.failureReason).length,A=Y-$,Z=X.filter((q)=>q.warnings&&q.warnings.length>0).length,V=`
`+K.box("GitLab \u9879\u76EE\u8FC1\u79FB\u62A5\u544A")+`
`;if(this.selectedProjects.length>0)V+=K.info(`\u6307\u5B9A\u8FC1\u79FB\u9879\u76EE: ${K.highlight(this.selectedProjects.join(", "))}`)+`
`;if(V+=K.info(`\u603B\u8BA1: ${K.highlight(Y.toString())} \u4E2A\u4ED3\u5E93`)+`
`,V+=K.success(`\u6210\u529F: ${K.highlight($.toString())} \u4E2A\u4ED3\u5E93`)+`
`,A>0)V+=K.error(`\u5931\u8D25: ${K.highlight(A.toString())} \u4E2A\u4ED3\u5E93`)+`
`;else V+=K.success(`\u5931\u8D25: ${K.highlight("0")} \u4E2A\u4ED3\u5E93`)+`
`;if(Z>0)V+=K.warning(`\u8B66\u544A: ${K.highlight(Z.toString())} \u4E2A\u4ED3\u5E93`)+`
`;let _=Y>0?Math.round($/Y*100):0,G=_===100?K.success:_>=80?K.warning:K.error;if(V+=G(`\u6210\u529F\u7387: ${K.highlight(_+"%")}`)+`
`,Z>0)V+=`
`+K.warning("\u6709\u8B66\u544A\u7684\u4ED3\u5E93:")+`
`,X.filter((q)=>q.warnings&&q.warnings.length>0).forEach((q)=>{V+=K.warning(`  \u2022 ${K.highlight(q.projectName)}:`)+`
`,q.warnings.forEach((H)=>{V+=K.dim(`    - ${H}`)+`
`})});if(A>0)V+=`
`+K.error("\u5931\u8D25\u7684\u4ED3\u5E93:")+`
`,X.filter((q)=>q.failureReason).forEach((q)=>{V+=K.error(`  \u2022 ${K.highlight(q.projectName)}: ${q.failureReason}`)+`
`});return V}}function j(Q){console.log(`
\uD83E\uDDF9 \u7A0B\u5E8F\u9000\u51FA\uFF0C\u6B63\u5728\u6E05\u7406\u4E34\u65F6\u6587\u4EF6...`);let B={logsSaved:!1,tempDirsFound:0,tempDirsDeleted:0,errors:[]};if(Q)try{Q.forceSaveMigrationLogs(),B.logsSaved=!0,console.log("\uD83D\uDCBE \u5DF2\u4FDD\u5B58\u8FC1\u79FB\u65E5\u5FD7")}catch(X){let Y=`\u4FDD\u5B58\u8FC1\u79FB\u65E5\u5FD7\u5931\u8D25: ${X instanceof Error?X.message:String(X)}`;B.errors.push(Y),console.log(K.warning(`\u26A0\uFE0F  ${Y}`))}try{let X=process.cwd();console.log(K.dim(`\uD83D\uDCC1 \u626B\u63CF\u76EE\u5F55: ${X}`));let Y=[];try{Y=R(X)}catch(A){let Z=`\u8BFB\u53D6\u76EE\u5F55\u5931\u8D25: ${A instanceof Error?A.message:String(A)}`;B.errors.push(Z),console.log(K.error(`\u274C ${Z}`));return}let $=Y.filter((A)=>{try{let Z=W.join(X,A),V=T(Z).isDirectory(),_=A.startsWith("temp-migration-");return V&&_}catch(Z){return console.log(K.warning(`\u26A0\uFE0F  \u68C0\u67E5\u6587\u4EF6 ${A} \u65F6\u51FA\u9519: ${Z instanceof Error?Z.message:String(Z)}`)),!1}});if(B.tempDirsFound=$.length,$.length>0)console.log(`\uD83D\uDDD1\uFE0F  \u53D1\u73B0 ${$.length} \u4E2A\u4E34\u65F6\u76EE\u5F55\uFF0C\u5F00\u59CB\u6E05\u7406...`),$.forEach((A)=>{try{let Z=W.join(X,A);if(console.log(K.dim(`   \uD83D\uDD04 \u6B63\u5728\u5220\u9664: ${A}`)),U(Z,{recursive:!0,force:!0}),!J(Z))B.tempDirsDeleted++,console.log(K.success(`   \u2705 \u5DF2\u5220\u9664: ${A}`));else{let V=`\u76EE\u5F55\u4ECD\u7136\u5B58\u5728: ${A}`;B.errors.push(V),console.log(K.warning(`   \u26A0\uFE0F  ${V}`))}}catch(Z){let V=`\u5220\u9664\u76EE\u5F55 ${A} \u5931\u8D25: ${Z instanceof Error?Z.message:String(Z)}`;B.errors.push(V),console.log(K.error(`   \u274C ${V}`))}});else console.log(K.dim("\uD83D\uDCC2 \u672A\u53D1\u73B0\u4E34\u65F6\u76EE\u5F55"));if(console.log(`
\uD83D\uDCCA \u6E05\u7406\u7ED3\u679C\u6458\u8981:`),console.log(K.dim(`   - \u8FC1\u79FB\u65E5\u5FD7\u4FDD\u5B58: ${B.logsSaved?"\u2705 \u6210\u529F":"\u274C \u5931\u8D25"}`)),console.log(K.dim(`   - \u53D1\u73B0\u4E34\u65F6\u76EE\u5F55: ${B.tempDirsFound} \u4E2A`)),console.log(K.dim(`   - \u6210\u529F\u5220\u9664: ${B.tempDirsDeleted} \u4E2A`)),console.log(K.dim(`   - \u9519\u8BEF\u6570\u91CF: ${B.errors.length} \u4E2A`)),B.errors.length>0)console.log(K.warning(`
\u26A0\uFE0F  \u6E05\u7406\u8FC7\u7A0B\u4E2D\u9047\u5230\u4EE5\u4E0B\u95EE\u9898:`)),B.errors.forEach((A,Z)=>{console.log(K.warning(`   ${Z+1}. ${A}`))});if(B.tempDirsDeleted===B.tempDirsFound&&B.errors.length===0)console.log(K.success("\u2705 \u6E05\u7406\u5B8C\u6210\uFF0C\u6240\u6709\u4E34\u65F6\u6587\u4EF6\u5DF2\u5220\u9664"));else console.log(K.warning("\u26A0\uFE0F  \u6E05\u7406\u5B8C\u6210\uFF0C\u4F46\u5B58\u5728\u90E8\u5206\u95EE\u9898"))}catch(X){let Y=`\u6E05\u7406\u8FC7\u7A0B\u4E2D\u53D1\u751F\u672A\u9884\u671F\u7684\u9519\u8BEF: ${X instanceof Error?X.message:String(X)}`;console.log(K.error(`\uD83D\uDCA5 ${Y}`)),B.errors.push(Y)}}function M(Q){process.on("exit",()=>{}),process.on("SIGINT",()=>{console.log(`
\uD83D\uDED1 \u6536\u5230\u4E2D\u65AD\u4FE1\u53F7 (Ctrl+C)`),j(Q),process.exit(0)}),process.on("SIGTERM",()=>{console.log(`
\uD83D\uDED1 \u6536\u5230\u7EC8\u6B62\u4FE1\u53F7`),j(Q),process.exit(0)}),process.on("uncaughtException",(B)=>{console.error(`
\uD83D\uDCA5 \u672A\u6355\u83B7\u7684\u5F02\u5E38:`,B.message),j(Q),process.exit(1)}),process.on("unhandledRejection",(B,X)=>{console.error(`
\uD83D\uDCA5 \u672A\u5904\u7406\u7684 Promise \u62D2\u7EDD:`,B),j(Q),process.exit(1)})}function w(Q=process.cwd()){let B=W.join(Q,"move.md");if(J(B)){console.log(K.warning(`\u26A0\uFE0F  \u914D\u7F6E\u6587\u4EF6\u5DF2\u5B58\u5728: ${B}`)),console.log(K.info("\u5982\u9700\u91CD\u65B0\u521D\u59CB\u5316\uFF0C\u8BF7\u5148\u5220\u9664\u73B0\u6709\u6587\u4EF6"));return}let X=W.dirname(B);if(!J(X))k(X,{recursive:!0});let Y=`# Gitlab \u9879\u76EE\u8FC1\u79FB\u5230\u65B0\u7684\u5206\u7EC4

## \u8FC1\u79FB\u76EE\u6807 Access Token

your_gitlab_access_token

## \u8FC1\u79FB\u76EE\u6807\u5206\u7EC4

https://gitlab.example.com/target-group/

## \u9700\u8981\u8FC1\u79FB\u4ED3\u5E93

| \u9879\u76EE\u540D\u79F0 | \u9879\u76EE\u63CF\u8FF0 | \u539F\u4ED3\u5E93\u5730\u5740 |
|---------|---------|----------|
| project1 | \u9879\u76EE1\u63CF\u8FF0 | ssh://git@gitlab.example.com:10022/old-group/project1.git |
| project2 | \u9879\u76EE2\u63CF\u8FF0 | ssh://git@gitlab.example.com:10022/old-group/project2.git |

## \u65E5\u5FD7

<!-- \u8FC1\u79FB\u65E5\u5FD7\u5C06\u81EA\u52A8\u751F\u6210\u5728\u8FD9\u91CC -->
`;try{b(B,Y,"utf8"),console.log(K.success(`\u2705 \u914D\u7F6E\u6587\u4EF6\u521D\u59CB\u5316\u6210\u529F: ${B}`)),console.log(""),console.log(K.info("\uD83D\uDCDD \u8BF7\u7F16\u8F91\u914D\u7F6E\u6587\u4EF6\u5E76\u586B\u5165\u6B63\u786E\u7684\u4FE1\u606F:")),console.log(K.dim("   1. \u8BBE\u7F6E\u76EE\u6807 GitLab \u5730\u5740")),console.log(K.dim("   2. \u8BBE\u7F6E\u76EE\u6807\u5206\u7EC4\u8DEF\u5F84")),console.log(K.dim("   3. \u8BBE\u7F6E Access Token")),console.log(K.dim("   4. \u6DFB\u52A0\u9700\u8981\u8FC1\u79FB\u7684\u9879\u76EE\u4FE1\u606F")),console.log(""),console.log(K.info("\uD83D\uDE80 \u914D\u7F6E\u5B8C\u6210\u540E\uFF0C\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\u5F00\u59CB\u8FC1\u79FB:")),console.log(K.highlight("   bun run migrate-gitlab.ts")),console.log(K.highlight("   mgitlab")),console.log(K.highlight("   mgitlab --help     # \u67E5\u770B\u66F4\u591A\u8BE6\u7EC6\u7684\u4F7F\u7528\u8BF4\u660E\u548C\u793A\u4F8B"))}catch($){console.error(K.error(`\u274C \u521D\u59CB\u5316\u914D\u7F6E\u6587\u4EF6\u5931\u8D25: ${$ instanceof Error?$.message:String($)}`)),process.exit(1)}}function L(){let Q,B=import.meta.url.replace("file:///","").replace(/\/[^/]*$/,""),X=[W.join(B,"package.json"),W.join(B,"../package.json"),W.join(B,"../../package.json"),"./package.json","../package.json","./dist/package.json"];for(let Y of X)try{if(J(Y)){Q=JSON.parse(P(Y,"utf-8"));break}}catch($){}if(!Q){console.log(K.error("\u65E0\u6CD5\u627E\u5230 package.json \u6587\u4EF6"));return}console.log(K.box(`GitLab \u9879\u76EE\u8FC1\u79FB\u5DE5\u5177 v${Q.version}`)),console.log(""),console.log(K.info("\u9879\u76EE\u4FE1\u606F:")),console.log(K.dim(`  \u540D\u79F0: ${Q.name}`)),console.log(K.dim(`  \u7248\u672C: ${Q.version}`)),console.log(K.dim(`  \u63CF\u8FF0: ${Q.description}`)),console.log(K.dim(`  \u4F5C\u8005: ${Q.author}`)),console.log(K.dim(`  \u8BB8\u53EF\u8BC1: ${Q.license}`)),console.log(""),console.log(K.info("\u8FD0\u884C\u73AF\u5883:")),console.log(K.dim(`  Node.js: ${process.version}`)),console.log(K.dim(`  \u5E73\u53F0: ${process.platform} ${process.arch}`)),console.log("")}function x(){let Q,B=import.meta.url.replace("file:///","").replace(/\/[^/]*$/,""),X=[W.join(B,"package.json"),W.join(B,"../package.json"),W.join(B,"../../package.json"),"./package.json","../package.json","./dist/package.json"];for(let Y of X)try{if(J(Y)){Q=JSON.parse(P(Y,"utf-8"));break}}catch($){}if(!Q){console.log(K.error("\u65E0\u6CD5\u627E\u5230 package.json \u6587\u4EF6"));return}console.log(K.box(`GitLab \u9879\u76EE\u8FC1\u79FB\u5DE5\u5177 v${Q.version}`)),console.log(""),console.log(K.info("\u63CF\u8FF0:")),console.log(K.dim("  \u4E13\u4E1A\u7684 GitLab \u4ED3\u5E93\u8FC1\u79FB\u5DE5\u5177\uFF0C\u652F\u6301\u6279\u91CF\u8FC1\u79FB\u3001\u65AD\u70B9\u7EED\u4F20\u3001\u667A\u80FD\u91CD\u8BD5\u7B49\u529F\u80FD")),console.log(""),console.log(K.info("\u7528\u6CD5:")),console.log(K.dim("  \u5168\u5C40\u5B89\u88C5\u540E:")),console.log(K.highlight("    migrate-gitlab [\u9009\u9879] [\u53C2\u6570]")),console.log(K.highlight("    mgitlab [\u9009\u9879] [\u53C2\u6570]")),console.log(""),console.log(K.dim("  \u672C\u5730\u8FD0\u884C:")),console.log(K.highlight("    bun run migrate-gitlab.ts [\u9009\u9879] [\u53C2\u6570]")),console.log(""),console.log(K.info("\u547D\u4EE4:")),console.log(K.dim("  init [\u76EE\u5F55]           \u521D\u59CB\u5316\u914D\u7F6E\u6587\u4EF6\u5230\u6307\u5B9A\u76EE\u5F55 (\u9ED8\u8BA4: \u5F53\u524D\u76EE\u5F55)")),console.log(K.dim("  migrate [\u914D\u7F6E\u6587\u4EF6]    \u6267\u884C\u8FC1\u79FB\u4EFB\u52A1 (\u9ED8\u8BA4: ./move.md)")),console.log(""),console.log(K.info("\u9009\u9879:")),console.log(K.dim("  -h, --help           \u663E\u793A\u5E2E\u52A9\u4FE1\u606F")),console.log(K.dim("  -v, --version        \u663E\u793A\u7248\u672C\u4FE1\u606F")),console.log(K.dim("  -p, --projects       \u6307\u5B9A\u8981\u8FC1\u79FB\u7684\u9879\u76EE\u5217\u8868 (\u9017\u53F7\u5206\u9694)")),console.log(K.dim("  -t, --token          \u6307\u5B9A GitLab Access Token")),console.log(K.dim("  -s, --skip-clone     \u7981\u7528\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93\u5230\u672C\u5730")),console.log(K.dim("  -q, --quiet          \u7B80\u5316\u63A7\u5236\u53F0\u8F93\u51FA\uFF0C\u9690\u85CF\u547D\u4EE4\u6267\u884C\u8BE6\u60C5")),console.log(""),console.log(K.info("\u53C2\u6570\u8BF4\u660E:")),console.log(K.dim("  \u914D\u7F6E\u6587\u4EF6\u8DEF\u5F84         move.md \u914D\u7F6E\u6587\u4EF6\u7684\u8DEF\u5F84 (\u9ED8\u8BA4: ./move.md)")),console.log(K.dim("  \u9879\u76EE\u5217\u8868            \u9017\u53F7\u5206\u9694\u7684\u9879\u76EE\u540D\u79F0\u5217\u8868")),console.log(K.dim("  Access Token        GitLab Access Token")),console.log(K.dim("  \u76EE\u6807\u76EE\u5F55            \u521D\u59CB\u5316\u914D\u7F6E\u6587\u4EF6\u7684\u76EE\u5F55")),console.log(""),console.log(K.info("\u793A\u4F8B:")),console.log(K.dim("  # \u521D\u59CB\u5316\u914D\u7F6E\u6587\u4EF6")),console.log(K.highlight("  mgitlab init")),console.log(K.highlight("  mgitlab init /path/to/project")),console.log(""),console.log(K.dim("  # \u663E\u793A\u7248\u672C\u548C\u5E2E\u52A9")),console.log(K.highlight("  mgitlab --version")),console.log(K.highlight("  mgitlab --help")),console.log(""),console.log(K.dim("  # \u8FC1\u79FB\u6240\u6709\u9879\u76EE")),console.log(K.highlight("  mgitlab")),console.log(K.highlight("  mgitlab ./move.md")),console.log(""),console.log(K.dim("  # \u8FC1\u79FB\u6307\u5B9A\u9879\u76EE")),console.log(K.highlight('  mgitlab --projects "project1,project2"')),console.log(K.highlight('  mgitlab ./move.md "project1,project2"')),console.log(""),console.log(K.dim("  # \u4F7F\u7528\u6307\u5B9A Token")),console.log(K.highlight("  mgitlab --token your_gitlab_token")),console.log(K.highlight('  mgitlab ./move.md "" your_gitlab_token')),console.log(""),console.log(K.dim("  # \u7981\u7528\u514B\u9686\u8FC1\u79FB\u540E\u7684\u4ED3\u5E93")),console.log(K.highlight("  mgitlab --skip-clone")),console.log(K.highlight('  mgitlab --projects "project1,project2" --skip-clone')),console.log(""),console.log(K.info("\u529F\u80FD\u7279\u6027:")),console.log(K.dim("  \u2705 \u6279\u91CF\u8FC1\u79FB\u591A\u4E2A GitLab \u4ED3\u5E93")),console.log(K.dim("  \u2705 \u65AD\u70B9\u7EED\u4F20\uFF0C\u652F\u6301\u4ECE\u4E2D\u65AD\u70B9\u7EE7\u7EED")),console.log(K.dim("  \u2705 \u667A\u80FD\u91CD\u8BD5\u673A\u5236\uFF0C\u81EA\u52A8\u5904\u7406\u4E34\u65F6\u9519\u8BEF")),console.log(K.dim("  \u2705 \u5B8C\u6574\u7684\u955C\u50CF\u514B\u9686\uFF0C\u4FDD\u7559\u6240\u6709\u5206\u652F\u548C\u6807\u7B7E")),console.log(K.dim("  \u2705 \u81EA\u52A8\u521B\u5EFA\u76EE\u6807\u4ED3\u5E93\u548C\u66F4\u65B0\u63CF\u8FF0")),console.log(K.dim("  \u2705 \u8BE6\u7EC6\u7684\u8FC1\u79FB\u65E5\u5FD7\u548C\u8FDB\u5EA6\u62A5\u544A")),console.log(K.dim("  \u2705 \u914D\u7F6E\u6587\u4EF6\u81EA\u52A8\u5907\u4EFD\u548C\u5783\u573E\u6E05\u7406")),console.log(K.dim("  \u2705 \u9884\u68C0\u67E5\u673A\u5236\uFF0C\u9A8C\u8BC1\u6743\u9650\u548C\u7F51\u7EDC\u8FDE\u901A\u6027")),console.log(""),console.log(K.info("\u66F4\u591A\u4FE1\u606F:")),console.log(K.dim("  \u6587\u6863: https://github.com/Garynan52000/migrate-gitlab#readme")),console.log(K.dim("  \u95EE\u9898\u53CD\u9988: https://github.com/Garynan52000/migrate-gitlab/issues")),console.log("")}function m(Q){let B={},X=0;while(X<Q.length){let Y=Q[X];switch(Y){case"--help":case"-h":case"help":B.showHelp=!0;break;case"--version":case"-v":case"version":B.showVersion=!0;break;case"--projects":case"-p":B.projectList=Q[++X];break;case"--token":case"-t":B.accessToken=Q[++X];break;case"--skip-clone":case"-s":B.skipFinalClone=!0;break;case"--quiet":case"-q":B.quietMode=!0;break;case"init":if(B.command="init",X+1<Q.length&&!Q[X+1].startsWith("-"))B.targetDir=Q[++X];break;case"migrate":if(B.command="migrate",X+1<Q.length&&!Q[X+1].startsWith("-"))B.moveFilePath=Q[++X];break;default:if(!Y.startsWith("-")){if(!B.command)if(Y==="init")B.command="init";else if(Y.endsWith(".md")||Y.includes("/")||Y.includes("\\"))B.moveFilePath=Y,B.command="migrate";else{if(!B.projectList)B.projectList=Y;else if(!B.accessToken)B.accessToken=Y;B.command=B.command||"migrate"}else if(B.command==="init"&&!B.targetDir)B.targetDir=Y;else if(B.command==="migrate"&&!B.moveFilePath)B.moveFilePath=Y;else if(!B.projectList)B.projectList=Y;else if(!B.accessToken)B.accessToken=Y}break}X++}if(!B.command&&!B.showHelp&&!B.showVersion)B.command="migrate";if(B.command==="migrate"&&!B.moveFilePath)B.moveFilePath=W.resolve(process.cwd(),"move.md");if(B.command==="init"&&!B.targetDir)B.targetDir=process.cwd();return B}async function d(){let Q;try{let B=process.argv.slice(2),X=m(B);if(X.showVersion){L();return}if(X.showHelp||B.length===0&&!X.command)if(B.length===0)console.log("\uD83D\uDE80 GitLab \u9879\u76EE\u8FC1\u79FB\u5DE5\u5177\u542F\u52A8"),console.log("\uD83D\uDCCB \u6B63\u5728\u8BFB\u53D6\u8FC1\u79FB\u914D\u7F6E...");else{x();return}if(X.command==="init"){console.log("\uD83D\uDD27 \u521D\u59CB\u5316 GitLab \u8FC1\u79FB\u914D\u7F6E\u6587\u4EF6"),console.log(`\uD83D\uDCC1 \u76EE\u6807\u76EE\u5F55: ${X.targetDir}`),console.log(""),w(X.targetDir);return}if(X.command==="migrate"){console.log("\uD83D\uDE80 GitLab \u9879\u76EE\u8FC1\u79FB\u5DE5\u5177\u542F\u52A8"),console.log("\uD83D\uDCCB \u6B63\u5728\u8BFB\u53D6\u8FC1\u79FB\u914D\u7F6E...");let Y=[];if(X.projectList)Y=X.projectList.split(",").map((Z)=>Z.trim()).filter((Z)=>Z.length>0),console.log(`\uD83C\uDFAF \u6307\u5B9A\u8FC1\u79FB\u9879\u76EE: ${Y.join(", ")}`);else console.log("\uD83D\uDCE6 \u5C06\u8FC1\u79FB\u6240\u6709\u9879\u76EE");let $=X.accessToken||process.env.GITLAB_ACCESS_TOKEN;Q=new f(X.moveFilePath,Y,$,X.skipFinalClone,X.quietMode),M(Q),await Q.migrate();let A=Q.generateMigrationReport();console.log(A),console.log(`
\uD83C\uDF89 \u8FC1\u79FB\u4EFB\u52A1\u5B8C\u6210\uFF01`),j(Q);return}x()}catch(B){if(console.error(`
\uD83D\uDCA5 \u8FC1\u79FB\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF:`),console.error(B instanceof Error?B.message:String(B)),Q)console.log(`
\uD83E\uDDF9 \u6B63\u5728\u6E05\u7406\u4E34\u65F6\u6587\u4EF6...`),j(Q);else j();process.exit(1)}}if(process.argv[1]&&import.meta.url.endsWith(process.argv[1].replace(/\\/g,"/")))d();export{f as GitLabMigrator};

//# debugId=86FFB51EA07B026764756E2164756E21
